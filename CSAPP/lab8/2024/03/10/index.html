<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/avatar.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/avatar.jpg">
  <link rel="mask-icon" href="/images/avatar.jpg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":10,"offset":10,"onmobile":true},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="这是一场和计算机的邂逅.">
<meta property="og:type" content="article">
<meta property="og:title" content="CSAPP的lab8-proxylab">
<meta property="og:url" content="http://example.com/CSAPP/lab8/2024/03/10/index.html">
<meta property="og:site_name" content="Vite">
<meta property="og:description" content="这是一场和计算机的邂逅.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202408191629012.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202408191737045.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202408191737587.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202408191741326.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202408191743925.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202408191819502.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202408180454911.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202408180455756.png">
<meta property="article:published_time" content="2024-03-10T07:08:00.000Z">
<meta property="article:modified_time" content="2024-08-19T10:48:00.000Z">
<meta property="article:author" content="zhz_vite">
<meta property="article:tag" content="学习笔记">
<meta property="article:tag" content="csapp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202408191629012.png">

<link rel="canonical" href="http://example.com/CSAPP/lab8/2024/03/10/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>CSAPP的lab8-proxylab | Vite</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Vite</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-study">

    <a href="/study/" rel="section"><i class="fa fa-anchor fa-fw"></i>不周山</a>

  </li>
        <li class="menu-item menu-item-create">

    <a href="/create/" rel="section"><i class="fa fa-sitemap fa-fw"></i>登天路</a>

  </li>
        <li class="menu-item menu-item-pure">

    <a href="/pure/" rel="section"><i class="fa fa-calendar fa-fw"></i>彼岸花</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/zhzvite" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/CSAPP/lab8/2024/03/10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="zhz_vite">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Vite">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CSAPP的lab8-proxylab
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-03-10 15:08:00" itemprop="dateCreated datePublished" datetime="2024-03-10T15:08:00+08:00">2024-03-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-08-19 18:48:00" itemprop="dateModified" datetime="2024-08-19T18:48:00+08:00">2024-08-19</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSAPP/" itemprop="url" rel="index"><span itemprop="name">CSAPP</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/CSAPP/lab8/2024/03/10/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/CSAPP/lab8/2024/03/10/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>50k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>1:31</span>
            </span>
            <div class="post-description">这是一场和计算机的邂逅.</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>这三章基础特别薄弱，对着答案做的lab，需要认真研究，花费更多时间思考！</p>
</blockquote>
<h1 id="ProxyLab"><a href="#ProxyLab" class="headerlink" title="ProxyLab"></a>ProxyLab</h1><h2 id="课本知识研读"><a href="#课本知识研读" class="headerlink" title="课本知识研读"></a>课本知识研读</h2><h3 id="Chapter-10-System-Level-I-O"><a href="#Chapter-10-System-Level-I-O" class="headerlink" title="Chapter 10 System-Level I&#x2F;O"></a>Chapter 10 System-Level I&#x2F;O</h3><ul>
<li><p>Unix I&#x2F;O functions</p>
</li>
<li><p>Standard I&#x2F;O functions</p>
</li>
<li><p>Rio_functions</p>
</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202408191629012.png" alt="image-20240819162957109"></p>
<p>Use the standard I&#x2F;O functions whenever possible</p>
<p>Don’t use <code>scanf</code> or <code>rio_readlineb</code> to read binary files.— because many <code>0xa</code>bytes</p>
<p>Use the Rio functions for I&#x2F;O on network sockets.—Application processes communicate with processes running on other computers on other computers by reading and writing socket descriptors.</p>
<p><strong>Hints!: Use the <code>sprintf</code> function to format a string in memory and then send it to the socker using <code>rio_writen</code> .If you need formatted input ,use <code>rio_readlineb</code> to read an entire text line ,and then use <code>sscanf</code> to extract different fields from the text line.</strong></p>
<p>Because of some incompatible restrictions on Standard I&#x2F;O and network files,Unix i&#x2F;o rather than standard I&#x2F;O should be used for network applications</p>
<h3 id="Chapter-11-Network-Programming"><a href="#Chapter-11-Network-Programming" class="headerlink" title="Chapter 11 Network Programming"></a>Chapter 11 Network Programming</h3><p>Some Important Functions:</p>
<blockquote>
<p>The Client and Sever overview</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202408191737045.png" alt="image-20240819173003018"></p>
<h4 id="Tiny-Sever测试"><a href="#Tiny-Sever测试" class="headerlink" title="Tiny Sever测试"></a>Tiny Sever测试</h4><p>我们打开Lab文件内容，cd到<code>tiny</code>文件夹，随便试一个端口，例如<code>./tiny 1435</code>,由于我是在docker中做实验，所以我直接访问<code>localhost：1435</code>就能得到如下界面</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202408191737587.png" alt="image-20240819173752780"></p>
<p>输入以下网址能传入参数，调用<code>cgi-bin</code>中的文件<code>adder</code>执行加法并返回结果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:1435/cgi-bin/adder?1243&amp;342</span><br></pre></td></tr></table></figure>

<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202408191741326.png" alt="image-20240819174121202"></p>
<p>如果访问不存在的文件就会触发：</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202408191743925.png" alt="image-20240819174320549"></p>
<p>注意：在文件中储存语言txt类型文件以<code>html</code>的格式存储，故会有大量的<code>html</code>符号。</p>
<p>然后可以用Telnet测试一下，之后再补充。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yfceshi/p/7401085.html">参考链接</a></p>
<h4 id="Tiny源码分析"><a href="#Tiny源码分析" class="headerlink" title="Tiny源码分析"></a>Tiny源码分析</h4><p>所以我们就要分析一下在课本中最后给类tiny sever的每一个function，在这里会进行部分的注解便于我和读者理解</p>
<p>输入:client-&gt;Sever</p>
<p>example: </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Host Port</span><br><span class="line">GET /home.html HTTP/1.0</span><br></pre></td></tr></table></figure>

<p>解析请求头：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">method： GET</span><br><span class="line"></span><br><span class="line">uri： /home.html</span><br><span class="line"></span><br><span class="line">version: HTTP/1.0</span><br></pre></td></tr></table></figure>

<p>main程序</p>
<p>control functions </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> listenfd, connfd;</span><br><span class="line">    <span class="type">char</span> hostname[MAXLINE], port[MAXLINE];</span><br><span class="line">    <span class="type">socklen_t</span> clientlen;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_storage</span> clientaddr;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Check command line args */</span></span><br><span class="line">    <span class="keyword">if</span> (argc != <span class="number">2</span>) &#123;</span><br><span class="line">	<span class="built_in">fprintf</span>(stderr, <span class="string">&quot;usage: %s &lt;port&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">	<span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    listenfd = <span class="built_in">Open_listenfd</span>(argv[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">	clientlen = <span class="built_in">sizeof</span>(clientaddr);</span><br><span class="line">	connfd = <span class="built_in">Accept</span>(listenfd, (SA *)&amp;clientaddr, &amp;clientlen); <span class="comment">//line:netp:tiny:accept</span></span><br><span class="line">        <span class="built_in">Getnameinfo</span>((SA *) &amp;clientaddr, clientlen, hostname, MAXLINE, </span><br><span class="line">                    port, MAXLINE, <span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Accepted connection from (%s, %s)\n&quot;</span>, hostname, port);</span><br><span class="line">	<span class="built_in">doit</span>(connfd);                                             <span class="comment">//line:netp:tiny:doit</span></span><br><span class="line">	<span class="built_in">Close</span>(connfd);                                            <span class="comment">//line:netp:tiny:close</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>doit </p>
<p>handle one HTTP request&#x2F;response transaction</p>
<p>连接成功后处理请求头，将请求分为method，uri，version,通过string函数寻找裁切存储。</p>
<p>同时通过是否有<code>cgi-bin</code>这个参数来判断其是否是动态的。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * doit - handle one HTTP request/response transaction</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">/* $begin doit */</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">doit</span><span class="params">(<span class="type">int</span> fd)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> is_static;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stat</span> sbuf;</span><br><span class="line">    <span class="type">char</span> buf[MAXLINE], method[MAXLINE], uri[MAXLINE], version[MAXLINE];</span><br><span class="line">    <span class="type">char</span> filename[MAXLINE], cgiargs[MAXLINE];</span><br><span class="line">    <span class="type">rio_t</span> rio;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Read request line and headers */</span></span><br><span class="line">    <span class="built_in">Rio_readinitb</span>(&amp;rio, fd);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">Rio_readlineb</span>(&amp;rio, buf, MAXLINE))  <span class="comment">//line:netp:doit:readrequest</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, buf);</span><br><span class="line">    <span class="built_in">sscanf</span>(buf, <span class="string">&quot;%s %s %s&quot;</span>, method, uri, version);       <span class="comment">//line:netp:doit:parserequest</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strcasecmp</span>(method, <span class="string">&quot;GET&quot;</span>)) &#123;                     <span class="comment">//line:netp:doit:beginrequesterr</span></span><br><span class="line">        <span class="built_in">clienterror</span>(fd, method, <span class="string">&quot;501&quot;</span>, <span class="string">&quot;Not Implemented&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Tiny does not implement this method&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;                                                    <span class="comment">//line:netp:doit:endrequesterr</span></span><br><span class="line">    <span class="built_in">read_requesthdrs</span>(&amp;rio);                              <span class="comment">//line:netp:doit:readrequesthdrs</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Parse URI from GET request */</span></span><br><span class="line">    is_static = <span class="built_in">parse_uri</span>(uri, filename, cgiargs);       <span class="comment">//line:netp:doit:staticcheck</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">stat</span>(filename, &amp;sbuf) &lt; <span class="number">0</span>) &#123;                     <span class="comment">//line:netp:doit:beginnotfound</span></span><br><span class="line">	<span class="built_in">clienterror</span>(fd, filename, <span class="string">&quot;404&quot;</span>, <span class="string">&quot;Not found&quot;</span>,</span><br><span class="line">		    <span class="string">&quot;Tiny couldn&#x27;t find this file&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">    &#125;                                                    <span class="comment">//line:netp:doit:endnotfound</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (is_static) &#123; <span class="comment">/* Serve static content */</span>          </span><br><span class="line">	<span class="keyword">if</span> (!(<span class="built_in">S_ISREG</span>(sbuf.st_mode)) || !(S_IRUSR &amp; sbuf.st_mode)) &#123; <span class="comment">//line:netp:doit:readable</span></span><br><span class="line">	    <span class="built_in">clienterror</span>(fd, filename, <span class="string">&quot;403&quot;</span>, <span class="string">&quot;Forbidden&quot;</span>,</span><br><span class="line">			<span class="string">&quot;Tiny couldn&#x27;t read the file&quot;</span>);</span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">serve_static</span>(fd, filename, sbuf.st_size);        <span class="comment">//line:netp:doit:servestatic</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123; <span class="comment">/* Serve dynamic content */</span></span><br><span class="line">	<span class="keyword">if</span> (!(<span class="built_in">S_ISREG</span>(sbuf.st_mode)) || !(S_IXUSR &amp; sbuf.st_mode)) &#123; <span class="comment">//line:netp:doit:executable</span></span><br><span class="line">	    <span class="built_in">clienterror</span>(fd, filename, <span class="string">&quot;403&quot;</span>, <span class="string">&quot;Forbidden&quot;</span>,</span><br><span class="line">			<span class="string">&quot;Tiny couldn&#x27;t run the CGI program&quot;</span>);</span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">serve_dynamic</span>(fd, filename, cgiargs);            <span class="comment">//line:netp:doit:servedynamic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>read_requesthdrs：</p>
<p>read HTTP request headers</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">read_requesthdrs</span><span class="params">(<span class="type">rio_t</span> *rp)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> buf[MAXLINE];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Rio_readlineb</span>(rp, buf, MAXLINE);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, buf);</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">strcmp</span>(buf, <span class="string">&quot;\r\n&quot;</span>)) &#123;          <span class="comment">//line:netp:readhdrs:checkterm</span></span><br><span class="line">	<span class="built_in">Rio_readlineb</span>(rp, buf, MAXLINE);</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>, buf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>parse_uri</p>
<p>分割uri到filename 和cgi信息即：cgi信息指的是?后面的参数例如前面举得adder函数的例子，<code>?</code>后面的两个参数，中间有<code>&amp;</code>号,filename指<code>./home.html</code></p>
<p>parse URI into filename and CGI args return 0 if dynamic content, 1 if static</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">parse_uri</span><span class="params">(<span class="type">char</span> *uri, <span class="type">char</span> *filename, <span class="type">char</span> *cgiargs)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> *ptr;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strstr</span>(uri, <span class="string">&quot;cgi-bin&quot;</span>)) &#123;  <span class="comment">/* Static content */</span> <span class="comment">//line:netp:parseuri:isstatic</span></span><br><span class="line">	<span class="built_in">strcpy</span>(cgiargs, <span class="string">&quot;&quot;</span>);                             <span class="comment">//line:netp:parseuri:clearcgi</span></span><br><span class="line">	<span class="built_in">strcpy</span>(filename, <span class="string">&quot;.&quot;</span>);                           <span class="comment">//line:netp:parseuri:beginconvert1</span></span><br><span class="line">	<span class="built_in">strcat</span>(filename, uri);                           <span class="comment">//line:netp:parseuri:endconvert1</span></span><br><span class="line">	<span class="keyword">if</span> (uri[<span class="built_in">strlen</span>(uri)<span class="number">-1</span>] == <span class="string">&#x27;/&#x27;</span>)                   <span class="comment">//line:netp:parseuri:slashcheck</span></span><br><span class="line">	    <span class="built_in">strcat</span>(filename, <span class="string">&quot;home.html&quot;</span>);               <span class="comment">//line:netp:parseuri:appenddefault</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;  <span class="comment">/* Dynamic content */</span>                        <span class="comment">//line:netp:parseuri:isdynamic</span></span><br><span class="line">	ptr = <span class="built_in">index</span>(uri, <span class="string">&#x27;?&#x27;</span>);                           <span class="comment">//line:netp:parseuri:beginextract</span></span><br><span class="line">	<span class="keyword">if</span> (ptr) &#123;</span><br><span class="line">	    <span class="built_in">strcpy</span>(cgiargs, ptr+<span class="number">1</span>);</span><br><span class="line">	    *ptr = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> </span><br><span class="line">	    <span class="built_in">strcpy</span>(cgiargs, <span class="string">&quot;&quot;</span>);                         <span class="comment">//line:netp:parseuri:endextract</span></span><br><span class="line">	<span class="built_in">strcpy</span>(filename, <span class="string">&quot;.&quot;</span>);                           <span class="comment">//line:netp:parseuri:beginconvert2</span></span><br><span class="line">	<span class="built_in">strcat</span>(filename, uri);                           <span class="comment">//line:netp:parseuri:endconvert2</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>serve_static</p>
<p>静态内容直接访问输出即可</p>
<p>copy a file back to the client </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">serve_static</span><span class="params">(<span class="type">int</span> fd, <span class="type">char</span> *filename, <span class="type">int</span> filesize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> srcfd;</span><br><span class="line">    <span class="type">char</span> *srcp, filetype[MAXLINE], buf[MAXBUF];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Send response headers to client */</span></span><br><span class="line">    <span class="built_in">get_filetype</span>(filename, filetype);    <span class="comment">//line:netp:servestatic:getfiletype</span></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;HTTP/1.0 200 OK\r\n&quot;</span>); <span class="comment">//line:netp:servestatic:beginserve</span></span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;Server: Tiny Web Server\r\n&quot;</span>);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;Content-length: %d\r\n&quot;</span>, filesize);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;Content-type: %s\r\n\r\n&quot;</span>, filetype);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));    <span class="comment">//line:netp:servestatic:endserve</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Send response body to client */</span></span><br><span class="line">    srcfd = <span class="built_in">Open</span>(filename, O_RDONLY, <span class="number">0</span>); <span class="comment">//line:netp:servestatic:open</span></span><br><span class="line">    srcp = <span class="built_in">Mmap</span>(<span class="number">0</span>, filesize, PROT_READ, MAP_PRIVATE, srcfd, <span class="number">0</span>); <span class="comment">//line:netp:servestatic:mmap</span></span><br><span class="line">    <span class="built_in">Close</span>(srcfd);                       <span class="comment">//line:netp:servestatic:close</span></span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, srcp, filesize);     <span class="comment">//line:netp:servestatic:write</span></span><br><span class="line">    <span class="built_in">Munmap</span>(srcp, filesize);             <span class="comment">//line:netp:servestatic:munmap</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>get_filetype</p>
<p>确定文件内容，函数再chapter 10中有出现</p>
<p>derive file type from file name</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">get_filetype</span><span class="params">(<span class="type">char</span> *filename, <span class="type">char</span> *filetype)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">strstr</span>(filename, <span class="string">&quot;.html&quot;</span>))</span><br><span class="line">	<span class="built_in">strcpy</span>(filetype, <span class="string">&quot;text/html&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(filename, <span class="string">&quot;.gif&quot;</span>))</span><br><span class="line">	<span class="built_in">strcpy</span>(filetype, <span class="string">&quot;image/gif&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(filename, <span class="string">&quot;.png&quot;</span>))</span><br><span class="line">	<span class="built_in">strcpy</span>(filetype, <span class="string">&quot;image/png&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">strstr</span>(filename, <span class="string">&quot;.jpg&quot;</span>))</span><br><span class="line">	<span class="built_in">strcpy</span>(filetype, <span class="string">&quot;image/jpeg&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">	<span class="built_in">strcpy</span>(filetype, <span class="string">&quot;text/plain&quot;</span>);</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>serve_dynamic</p>
<p>run a CGI program on behalf of the client</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">serve_dynamic</span><span class="params">(<span class="type">int</span> fd, <span class="type">char</span> *filename, <span class="type">char</span> *cgiargs)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> buf[MAXLINE], *emptylist[] = &#123; <span class="literal">NULL</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Return first part of HTTP response */</span></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;HTTP/1.0 200 OK\r\n&quot;</span>); </span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;Server: Tiny Web Server\r\n&quot;</span>);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Fork</span>() == <span class="number">0</span>) &#123; <span class="comment">/* Child */</span> <span class="comment">//line:netp:servedynamic:fork</span></span><br><span class="line">	<span class="comment">/* Real server would set all CGI vars here */</span></span><br><span class="line">	<span class="built_in">setenv</span>(<span class="string">&quot;QUERY_STRING&quot;</span>, cgiargs, <span class="number">1</span>); <span class="comment">//line:netp:servedynamic:setenv</span></span><br><span class="line">	<span class="built_in">Dup2</span>(fd, STDOUT_FILENO);         <span class="comment">/* Redirect stdout to client */</span> <span class="comment">//line:netp:servedynamic:dup2</span></span><br><span class="line">	<span class="built_in">Execve</span>(filename, emptylist, environ); <span class="comment">/* Run CGI program */</span> <span class="comment">//line:netp:servedynamic:execve</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Wait</span>(<span class="literal">NULL</span>); <span class="comment">/* Parent waits for and reaps child */</span> <span class="comment">//line:netp:servedynamic:wait</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>clienterror</p>
<p>报错信息，负责输出html报错语言，输出记得要用Rio_Writen函数</p>
<p>returns an error message to the client</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">clienterror</span><span class="params">(<span class="type">int</span> fd, <span class="type">char</span> *cause, <span class="type">char</span> *errnum, </span></span></span><br><span class="line"><span class="params"><span class="function">		 <span class="type">char</span> *shortmsg, <span class="type">char</span> *longmsg)</span> </span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> buf[MAXLINE];</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Print the HTTP response headers */</span></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;HTTP/1.0 %s %s\r\n&quot;</span>, errnum, shortmsg);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;Content-type: text/html\r\n\r\n&quot;</span>);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Print the HTTP response body */</span></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;&lt;html&gt;&lt;title&gt;Tiny Error&lt;/title&gt;&quot;</span>);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;&lt;body bgcolor=&quot;</span><span class="string">&quot;ffffff&quot;</span><span class="string">&quot;&gt;\r\n&quot;</span>);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;%s: %s\r\n&quot;</span>, errnum, shortmsg);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;&lt;p&gt;%s: %s\r\n&quot;</span>, longmsg, cause);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;&lt;hr&gt;&lt;em&gt;The Tiny Web server&lt;/em&gt;\r\n&quot;</span>);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Chapter-12-Concurrent-Programming"><a href="#Chapter-12-Concurrent-Programming" class="headerlink" title="Chapter 12 Concurrent Programming"></a>Chapter 12 Concurrent Programming</h3><p>了解下锁和多线程，读者所，写者锁的内容即可。我还没读，只有浅显的了解。</p>
<h2 id="Lab"><a href="#Lab" class="headerlink" title="Lab"></a>Lab</h2><h3 id="环境调试"><a href="#环境调试" class="headerlink" title="环境调试"></a>环境调试</h3><ol>
<li>Docker 中容器开启多个终端会话</li>
</ol>
<p>[参考链接](<a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/ask/sof/114053010">Docker :如何为一个正在运行的容器启动多个控制台&#x2F;终端？-腾讯云开发者社区-腾讯云 (tencent.com)</a>)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a</span><br><span class="line">docker <span class="built_in">exec</span> -it ID bash</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Debug 工具</li>
</ol>
<p>curl</p>
<p>ubuntu中需要提前安装： <code>sudo apt install curl</code></p>
<blockquote>
<p>You can use curl to generate HTTP requests to any server, including your own proxy. It is an extremely useful debugging tool. For example, if your proxy and Tiny are both running on the local machine, Tiny is listening on port 15213, and proxy is listening on port 15214, then you can request a page from Tiny via your proxy using the following curl command: linux&gt; curl-v–proxy <a target="_blank" rel="noopener" href="http://localhost:15214/">http://localhost:15214</a> <a target="_blank" rel="noopener" href="http://localhost:15213/home.html">http://localhost:15213/home.html</a></p>
</blockquote>
<p>Telnet:用法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Telnet localhost port</span><br><span class="line">GET /home.html HTTP 1.0</span><br></pre></td></tr></table></figure>

<h3 id="目标总览"><a href="#目标总览" class="headerlink" title="目标总览"></a>目标总览</h3><blockquote>
<p>In this lab, you will write a simple HTTP proxy that caches web objects. For the first part of the lab, you will set up the proxy to accept incoming connections, read and parse requests, forward requests to web servers, read the servers’ responses, and forward those responses to the corresponding clients. This first part will involve learning about basic HTTP operation and how to use sockets to write programs that communicate over network connections. In the second part, you will upgrade your proxy to deal with multiple concurrent connections. This will introduce you to dealing with concurrency, a crucial systems concept. In the third and last part, you will add caching to your proxy using a simple main memory cache of recently accessed web content.、</p>
</blockquote>
<p>这次要做的就是接受client的请求并分析转发后给sever，再把得到的数据转发个client。</p>
<h3 id="Part1"><a href="#Part1" class="headerlink" title="Part1"></a>Part1</h3><p><strong>Implementing a sequential web proxy</strong></p>
<p>这是在脚本中分别调用PROXY和TINY的命令。</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202408191819502.png" alt="image-20240819181935660"></p>
<p>实现顺序web代理</p>
<p>1、在main()里面创建一个监听描述符listenfd，然后在while的循环体里不断尝试与客户端进行连接connfd&#x3D;Accept(listenfd)。连接成功后将connfd传入请求处理函数handleRequest()中。</p>
<p>2、进入handRequest()后，分别创建好两个I&#x2F;O缓冲区rio_Proxy2Client和rio_Proxy2Server，Proxy可以利用这两个不同的缓冲区分别和Client与Server进行读写操作。</p>
<p>3、利用rio_Proxy2Client读入http-request，并把这个请求分割成writeup要求的几部分，即method、uri、version；其中url又可以分割为hostName、port和fielName。</p>
<p>4、处理完request的第一行后，开始处理后序的四个request header，少哪个header就自己补上哪个header。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Client-&gt; Proxy 	</span><br><span class="line">GET http://www.cmu.edu:8080/hub/index.html HTTP/1.1</span><br><span class="line"></span><br><span class="line">Proxy Prase:</span><br><span class="line">GET /hub/index.html HTTP1.1</span><br><span class="line">Host: www.cmu.edu</span><br><span class="line">port: 8080</span><br><span class="line"></span><br><span class="line">User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:10.0.3) Gecko/20120305 Firefox/10.0.3</span><br><span class="line"></span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">Proxy-Connection: close</span><br><span class="line"></span><br><span class="line">Proxy-&gt;Tiny Sever</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>5、Proxy利用刚才得到的hostName和port，调用clientfd&#x3D;Open_clientfd()冒充一个Client与Server建立连接。</p>
<p>6、Proxy利用clientfd和rio_Proxy2Server，先把从Client处得到的http-request发送给Server，然后不断读入Server回复的response。Proxy在读入response的同时，又利用connfd把它们发送给Client。</p>
<p>7、还得加上一个如果method不是“GET”的错误处理函数，直接照着书上的敲一遍或者把tiny.c的那个clientError()复制过来就行。</p>
<p><strong>Hints</strong></p>
<blockquote>
<p>• As discussed in Section 10.11 of your textbook, using standard I&#x2F;O functions for socket input and output is a problem. Instead, we recommend that you use the Robust I&#x2F;O (RIO) package, which is provided in the csapp.c file in the handout directory.<br>• The error-handling functions provide in csapp.c are not appropriate for your proxy because once a server begins accepting connections, it is not supposed to terminate. You’ll need to modify them or write your own.<br>• You are free to modify the files in the handout directory any way you like. For example, for the sake of good modularity, you might implement your cache functions as a library in files called cache.c and cache.h. Of course, adding new files will require you to update the provided Makefile.</p>
<p>• As discussed in the Aside on page 964 of the CS:APP3e text, your proxy must ignore SIGPIPE signals and should deal gracefully with write operations that return EPIPE errors.<br>• Sometimes, calling read to receive bytes from a socket that has been prematurely closed will cause read to return -1 with errno set to ECONNRESET. Your proxy should not terminate due to this error either.<br>• Remember that not all content on the web is ASCII text. Much of the content on the web is binary data, such as images and video. Ensure that you account for binary data when selecting and using functions for network I&#x2F;O.<br>• Forward all requests as HTTP&#x2F;1.0 even if the original request was HTTP&#x2F;1.1.<br>Good luck!</p>
</blockquote>
<p>只用搞定HTTP&#x2F;1.0 GET请求</p>
<p>将HTTP&#x2F;1.1的version信息换成HTTP&#x2F;1.0</p>
<blockquote>
<p>Note that all lines in an HTTP request end with a carriage return, ‘\r’, followed by a newline, ‘\n’. Also<br>important is that every HTTP request is terminated by an empty line: “\r\n”.</p>
</blockquote>
<h4 id="1-main"><a href="#1-main" class="headerlink" title="1. main"></a>1. <code>main</code></h4><p><strong>Purpose</strong>: The entry point of the program. It initializes the server, listens for incoming connections, and handles each request.</p>
<p><strong>Implementation</strong>:</p>
<ul>
<li><p><strong>Command-Line Argument Check</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(argc != <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;usage: %s &lt;port&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Ensures the user has provided exactly one argument (the port number). If not, it prints a usage message and exits the program.</p>
</li>
<li><p><strong>Open Listening Socket</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">listenfd = Open_listenfd(argv[<span class="number">1</span>]);</span><br></pre></td></tr></table></figure>
<p>Initializes a listening socket on the specified port.</p>
</li>
<li><p><strong>Main Loop</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(<span class="number">1</span>) &#123;</span><br><span class="line">    clientlen = <span class="keyword">sizeof</span>(clientaddr);</span><br><span class="line">    connfd = Accept(listenfd, (SA *)&amp;clientaddr, &amp;clientlen);</span><br><span class="line">    Getnameinfo((SA *)&amp;clientaddr, clientlen, hostname, MAXLINE, port, MAXLINE, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Accepted connection from (%s, %s)\n&quot;</span>, hostname, port);</span><br><span class="line">    handleRequest(connfd);</span><br><span class="line">    Close(connfd);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Continuously accepts connections from clients. For each accepted connection, it prints the client’s address, calls <code>handleRequest</code> to process the request, and then closes the connection.</p>
</li>
</ul>
<h4 id="2-handleRequest"><a href="#2-handleRequest" class="headerlink" title="2. handleRequest"></a>2. <code>handleRequest</code></h4><p><strong>Purpose</strong>: Handles HTTP requests from clients, forwards them to the target server, and sends the response back to the client.</p>
<p><strong>Implementation</strong>:</p>
<ul>
<li><p><strong>Initialize I&#x2F;O</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Rio_readinitb(&amp;rio, fd);</span><br></pre></td></tr></table></figure>
<p>Initializes the <code>rio</code> structure for reading from the client connection.</p>
</li>
<li><p><strong>Read Request Line</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!Rio_readlineb(&amp;rio, buf, MAXLINE)) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;empty request\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Reads the request line from the client into the <code>buf</code> buffer. If the request is empty, it prints a message and returns.</p>
</li>
<li><p><strong>Replace HTTP Version</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">replaceHTTPVersion(buf);</span><br></pre></td></tr></table></figure>
<p>the function</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *pos = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> ((pos = <span class="built_in">strstr</span>(buf, <span class="string">&quot;HTTP/1.1&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    buf[pos - buf + <span class="built_in">strlen</span>(<span class="string">&quot;HTTP/1.1&quot;</span>) - <span class="number">1</span>] = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Converts the HTTP version from 1.1 to 1.0.</p>
</li>
<li><p><strong>Parse Request Line</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">parseLine(buf, host, port, method, uri, version, filename);</span><br></pre></td></tr></table></figure>
<p>Parses the request line to extract HTTP method, URI, version, host, port, and filename.</p>
</li>
<li><p><strong>Check Method</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (strcasecmp(method, <span class="string">&quot;GET&quot;</span>)) &#123;</span><br><span class="line">    clientError(fd, method, <span class="string">&quot;501&quot;</span>, <span class="string">&quot;Not Implemented&quot;</span>, <span class="string">&quot;Tiny does not implement this method&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Checks if the HTTP method is GET. If not, it sends a 501 Not Implemented error response and returns.</p>
</li>
<li><p><strong>Build and Send Request</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> rv = MakeClientRequest(&amp;rio, clientRequest, host, port, method, uri, version, filename);</span><br><span class="line"><span class="keyword">if</span> (rv == <span class="number">0</span>) <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure>
<p>Calls <code>MakeClientRequest</code> to format the request for the target server. If formatting fails, it returns.</p>
</li>
<li><p><strong>Handle Server Response</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> clientfd = Open_clientfd(hostName, port);</span><br><span class="line">Rio_readinitb(&amp;riotiny, clientfd);</span><br><span class="line">Rio_writen(riotiny.rio_fd, clientRequest, <span class="built_in">strlen</span>(clientRequest));</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> tinyResponse[MAXLINE];</span><br><span class="line"><span class="type">int</span> n;</span><br><span class="line"><span class="keyword">while</span> ((n = Rio_readnb(&amp;riotiny, tinyResponse, MAXLINE)) != <span class="number">0</span>) &#123;</span><br><span class="line">    Rio_writen(fd, tinyResponse, n);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Opens a connection to the target server, sends the formatted request, and then reads the response from the server and writes it back to the client.</p>
</li>
</ul>
<h4 id="3-MakeClientRequest"><a href="#3-MakeClientRequest" class="headerlink" title="3. MakeClientRequest"></a>3. <code>MakeClientRequest</code></h4><p><strong>Purpose</strong>: Constructs the HTTP request to be sent to the target server based on the client’s request.</p>
<p><strong>Implementation</strong>:</p>
<ul>
<li><p><strong>Initialize Request</strong>:</p>
</li>
<li><p>注意换行符是<code>\r\n</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sprintf</span>(clientRequest, <span class="string">&quot;GET %s HTTP/1.0\r\n&quot;</span>, fileName);</span><br></pre></td></tr></table></figure>
<p>Initializes the request with the method (GET), the file name, and HTTP version 1.0.</p>
</li>
<li><p><strong>Read and Process Headers</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">n = Rio_readlineb(rio, buf, MAXLINE);</span><br><span class="line"><span class="keyword">while</span> (<span class="built_in">strcmp</span>(<span class="string">&quot;\r\n&quot;</span>, buf) != <span class="number">0</span> &amp;&amp; n != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">strcat</span>(clientRequest, buf);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((findp = <span class="built_in">strstr</span>(buf, <span class="string">&quot;User-Agent:&quot;</span>)) != <span class="literal">NULL</span>) UserAgent = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ((findp = <span class="built_in">strstr</span>(buf, <span class="string">&quot;Proxy-Connection:&quot;</span>)) != <span class="literal">NULL</span>) ProxyConnection = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ((findp = <span class="built_in">strstr</span>(buf, <span class="string">&quot;Connection:&quot;</span>)) != <span class="literal">NULL</span>) Connection = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ((findp = <span class="built_in">strstr</span>(buf, <span class="string">&quot;Host:&quot;</span>)) != <span class="literal">NULL</span>) HostInfo = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    n = Rio_readlineb(rio, buf, MAXLINE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Reads headers from the client request and appends them to <code>clientRequest</code>. It also checks for specific headers like <code>User-Agent</code>, <code>Proxy-Connection</code>, <code>Connection</code>, and <code>Host</code>.</p>
</li>
<li><p><strong>Add Missing Headers</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (HostInfo == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;Host: %s\r\n&quot;</span>, Host);</span><br><span class="line">    <span class="built_in">strcat</span>(clientRequest, buf);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (UserAgent == <span class="number">0</span>) <span class="built_in">strcat</span>(clientRequest, user_agent_hdr);</span><br><span class="line"><span class="keyword">if</span> (Connection == <span class="number">0</span>) <span class="built_in">sprintf</span>(buf, <span class="string">&quot;Connection: close\r\n&quot;</span>); <span class="built_in">strcat</span>(clientRequest, buf);</span><br><span class="line"><span class="keyword">if</span> (ProxyConnection == <span class="number">0</span>) <span class="built_in">sprintf</span>(buf, <span class="string">&quot;Proxy-Connection: close\r\n&quot;</span>); <span class="built_in">strcat</span>(clientRequest, buf);</span><br></pre></td></tr></table></figure>
<p>Adds missing headers like <code>Host</code>, <code>User-Agent</code>, <code>Connection</code>, and <code>Proxy-Connection</code> if they were not provided by the client.</p>
</li>
<li><p><strong>Terminate Request</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">strcat</span>(clientRequest, <span class="string">&quot;\r\n&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>Adds a terminator for the HTTP request to indicate the end of the request headers.</p>
</li>
</ul>
<h4 id="4-replaceHTTPVersion"><a href="#4-replaceHTTPVersion" class="headerlink" title="4. replaceHTTPVersion"></a>4. <code>replaceHTTPVersion</code></h4><p><strong>Purpose</strong>: Replaces HTTP version 1.1 with 1.0 in the request line.</p>
<p><strong>Implementation</strong>:</p>
<ul>
<li><strong>Find and Replace</strong>:<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *pos = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> ((pos = <span class="built_in">strstr</span>(buf, <span class="string">&quot;HTTP/1.1&quot;</span>)) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">    buf[pos - buf + <span class="built_in">strlen</span>(<span class="string">&quot;HTTP/1.1&quot;</span>) - <span class="number">1</span>] = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
Searches for “HTTP&#x2F;1.1” in the buffer and replaces it with “HTTP&#x2F;1.0”.</li>
</ul>
<h4 id="5-parseLine"><a href="#5-parseLine" class="headerlink" title="5. parseLine"></a>5. <code>parseLine</code></h4><p><strong>Purpose</strong>: Parses the request line to extract method, URI, version, host, port, and filename.</p>
<p><strong>Implementation</strong>:</p>
<ul>
<li><p><strong>Parse Request Line</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sscanf</span>(buf, <span class="string">&quot;%s %s %s&quot;</span>, method, uri, version);</span><br></pre></td></tr></table></figure>
<p>Uses <code>sscanf</code> to extract the HTTP method, URI, and version from the request line.</p>
</li>
<li><p><strong>Extract Host, Port, and Filename</strong>:</p>
</li>
<li><p><code>WEB_PREFIX=&quot;http://&quot;</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">char</span> *hostp = <span class="built_in">strstr</span>(uri, WEB_PREFIX) + <span class="built_in">strlen</span>(WEB_PREFIX);</span><br><span class="line"><span class="type">char</span> *slash = <span class="built_in">strstr</span>(hostp, <span class="string">&quot;/&quot;</span>);</span><br><span class="line"><span class="type">char</span> *colon = <span class="built_in">strstr</span>(hostp, <span class="string">&quot;:&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">strncpy</span>(host, hostp, slash - hostp);</span><br><span class="line"><span class="built_in">strncpy</span>(port, colon + <span class="number">1</span>, slash - colon - <span class="number">1</span>);</span><br><span class="line"><span class="built_in">strcpy</span>(filename, slash);</span><br></pre></td></tr></table></figure>
<p>Extracts the host, port, and file path from the URI. </p>
<p>the host include the port</p>
</li>
</ul>
<h4 id="6-clientError"><a href="#6-clientError" class="headerlink" title="6. clientError"></a>6. <code>clientError</code></h4><p><strong>Purpose</strong>: Generates and sends an HTTP error response to the client.</p>
<p><strong>Implementation</strong>:</p>
<ul>
<li><p><strong>Build and Send Response Headers</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sprintf</span>(buf, <span class="string">&quot;HTTP/1.0 %s %s\r\n&quot;</span>, errnum, shortmsg);</span><br><span class="line">Rio_writen(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line"><span class="built_in">sprintf</span>(buf, <span class="string">&quot;Content-type: text/html\r\n\r\n&quot;</span>);</span><br><span class="line">Rio_writen(fd, buf, <span class="built_in">strlen</span>(buf));</span><br></pre></td></tr></table></figure>
<p>Creates the HTTP status line and content type header, then sends them to the client.</p>
</li>
<li><p><strong>Build and Send Response Body</strong>:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sprintf</span>(buf, <span class="string">&quot;&lt;html&gt;&lt;title&gt;Tiny Error&lt;/title&gt;&quot;</span>);</span><br><span class="line">Rio_writen(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line"><span class="built_in">sprintf</span>(buf, <span class="string">&quot;&lt;body bgcolor=\&quot;ffffff\&quot;&gt;\r\n&quot;</span>);</span><br><span class="line">Rio_writen(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line"><span class="built_in">sprintf</span>(buf, <span class="string">&quot;%s: %s\r\n&quot;</span>, errnum, shortmsg);</span><br><span class="line">Rio_writen(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line"><span class="built_in">sprintf</span>(buf, <span class="string">&quot;&lt;p&gt;%s: %s\r\n&quot;</span>, longmsg, cause);</span><br><span class="line">Rio_writen(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line"><span class="built_in">sprintf</span>(buf, <span class="string">&quot;&lt;hr&gt;&lt;em&gt;The Tiny Web server&lt;/em&gt;\r\n&quot;</span>);</span><br><span class="line">Rio_writen(fd, buf, <span class="built_in">strlen</span>(buf));</span><br></pre></td></tr></table></figure>
<p>Creates and sends the HTML content of the error page, including the error number, short message, and detailed message.</p>
</li>
</ul>
<h4 id="完整代码："><a href="#完整代码：" class="headerlink" title="完整代码："></a>完整代码：</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;csapp.h&quot;</span></span></span><br><span class="line"><span class="comment">/* Recommended max cache and object sizes */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_CACHE_SIZE 1049000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_OBJECT_SIZE 102400</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEB_PREFIX <span class="string">&quot;http://&quot;</span></span></span><br><span class="line"><span class="comment">/* You won&#x27;t lose style points for including this long line in your code */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *user_agent_hdr = <span class="string">&quot;User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:10.0.3) Gecko/20120305 Firefox/10.0.3\r\n&quot;</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">handleRequest</span><span class="params">(<span class="type">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">clientError</span><span class="params">(<span class="type">int</span> , <span class="type">char</span>* , <span class="type">char</span>* , <span class="type">char</span>* , <span class="type">char</span>* )</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">MakeClientRequest</span><span class="params">(<span class="type">rio_t</span>* , <span class="type">char</span>* , <span class="type">char</span>*, <span class="type">char</span>* , <span class="type">char</span>* , <span class="type">char</span>* , <span class="type">char</span>*, <span class="type">char</span>*)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">checkGetMethod</span><span class="params">(<span class="type">char</span>* , <span class="type">char</span>* , <span class="type">char</span>* )</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">replaceHTTPVersion</span><span class="params">(<span class="type">char</span>* )</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">parseLine</span><span class="params">(<span class="type">char</span>* , <span class="type">char</span>*, <span class="type">char</span>* , <span class="type">char</span>* , <span class="type">char</span>* , <span class="type">char</span>*, <span class="type">char</span>*)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc,<span class="type">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> listenfd,connfd;</span><br><span class="line">    <span class="type">char</span> hostname[MAXLINE],port[MAXLINE];</span><br><span class="line">    <span class="type">socklen_t</span> clientlen;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_storage</span> clientaddr;</span><br><span class="line">    <span class="comment">//判断是否是两个命令</span></span><br><span class="line">    <span class="keyword">if</span>(argc!=<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr,<span class="string">&quot;usage: Fuck ,can you input only two string ?\nsuch as%s &lt;port&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">       <span class="comment">// printf(&quot;Fuck ,input right message \n&quot;);</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    listenfd =<span class="built_in">Open_listenfd</span>(argv[<span class="number">1</span>]);   <span class="comment">//listen a port</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        clientlen =<span class="built_in">sizeof</span> (clientaddr);</span><br><span class="line">        connfd = <span class="built_in">Accept</span>(listenfd ,(SA *)&amp;clientaddr, &amp;clientlen);</span><br><span class="line">        <span class="built_in">Getnameinfo</span>((SA *)&amp;clientaddr ,clientlen,hostname ,MAXLINE,port,MAXLINE,<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Accepted connection from (%s , %s)\n&quot;</span>, hostname ,port);<span class="comment">// accept了</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Connection Succeed</span></span><br><span class="line">        <span class="built_in">handlerequest</span>(connfd);</span><br><span class="line">        <span class="built_in">Close</span>(connfd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">handlerequest</span><span class="params">(<span class="type">int</span> fd)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> is_static;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">stat</span> sbuf;</span><br><span class="line">    <span class="type">char</span> buf[MAXLINE],method[MAXLINE],uri[MAXLINE],version[MAXLINE];<span class="comment">// buf </span></span><br><span class="line">    <span class="type">char</span> filename[MAXLINE];</span><br><span class="line">    <span class="comment">//request header</span></span><br><span class="line">    <span class="type">char</span> host[MAXLINE],port[MAXLINE];</span><br><span class="line">    <span class="type">char</span> clientRequest[MAXLINE];</span><br><span class="line">    <span class="comment">// IO for proxy--client ,proxy--server</span></span><br><span class="line">    <span class="type">rio_t</span> rio,riotiny;</span><br><span class="line">    <span class="comment">// Read request line and headers</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// step1: read request from client</span></span><br><span class="line">    <span class="built_in">Rio_readinitb</span>(&amp;rio,fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">Rio_readlineb</span>(&amp;rio ,buf, MAXLINE))<span class="comment">//把输入的命令给到buf缓冲区</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;empty request \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ;<span class="comment">// empty-&gt; close</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// # HTTP/1.1 --&gt; HTTp/1.0</span></span><br><span class="line">    <span class="built_in">replaceHTTPVersion</span>(buf);</span><br><span class="line">   <span class="built_in">parseLine</span>(buf,host,port,method,uri,version,filename);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strcasecmp</span>(method, <span class="string">&quot;GET&quot;</span>))&#123;</span><br><span class="line">        <span class="built_in">clienterror</span>(fd, method, <span class="string">&quot;501&quot;</span>, <span class="string">&quot;Not Implemented&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Tiny does not implement this method&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// parse uri from GET request </span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> rv=<span class="built_in">MakeClientRequest</span>(&amp;rio, clientRequest,host,port,method,uri,version,filename);</span><br><span class="line">    <span class="keyword">if</span>(rv==<span class="number">0</span>)<span class="keyword">return</span> ;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;========= we have formatted the reqeust into ---------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>,clientRequest);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> hostName[<span class="number">100</span>];</span><br><span class="line">    <span class="type">char</span>* colon = <span class="built_in">strstr</span>(host, <span class="string">&quot;:&quot;</span>);</span><br><span class="line">    <span class="built_in">strncpy</span>(hostName, host, colon - host);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;host is %s\n&quot;</span>, hostName);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;port is %s\n&quot;</span>, port);</span><br><span class="line">    <span class="comment">//模拟一个clientfd</span></span><br><span class="line">    <span class="type">int</span> clientfd = <span class="built_in">Open_clientfd</span>(hostName, port);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Rio_readinitb</span>(&amp;riotiny, clientfd);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(riotiny.rio_fd, clientRequest, <span class="built_in">strlen</span>(clientRequest));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** step4: read the response from tiny and send it to the client */</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---prepare to get the response---- \n&quot;</span>);</span><br><span class="line">    <span class="type">char</span> tinyResponse[MAXLINE];</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>( (n = <span class="built_in">Rio_readnb</span>(&amp;riotiny, tinyResponse, MAXLINE)) != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">Rio_writen</span>(fd, tinyResponse, n);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">MakeClientRequest</span><span class="params">(<span class="type">rio_t</span>* rio, <span class="type">char</span>* clientRequest, <span class="type">char</span>* Host, <span class="type">char</span>* port,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">char</span>* method, <span class="type">char</span>* uri, <span class="type">char</span>* version, <span class="type">char</span>* fileName)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> UserAgent = <span class="number">0</span>, Connection = <span class="number">0</span>, ProxyConnection = <span class="number">0</span>, HostInfo = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> buf[MAXLINE / <span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. add GET HOSTNAME HTTP/1.0 to header &amp;&amp; Host Info */</span></span><br><span class="line">    <span class="built_in">sprintf</span>(clientRequest, <span class="string">&quot;GET %s HTTP/1.0\r\n&quot;</span>, fileName);</span><br><span class="line"></span><br><span class="line">    n = <span class="built_in">Rio_readlineb</span>(rio, buf, MAXLINE);<span class="comment">// n是读取的字节数</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;receive buf %s\n&quot;</span>, buf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;n == %d\n&quot;</span>, n);</span><br><span class="line">    <span class="type">char</span>* findp;</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">strcmp</span>(<span class="string">&quot;\r\n&quot;</span>, buf) != <span class="number">0</span> &amp;&amp; n != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">strcat</span>(clientRequest, buf);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;receive buf %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( (findp = <span class="built_in">strstr</span>(buf, <span class="string">&quot;User-Agent:&quot;</span>)) != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            UserAgent = <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>( (findp = <span class="built_in">strstr</span>(buf, <span class="string">&quot;Proxy-Connection:&quot;</span>)) != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            ProxyConnection = <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>( (findp = <span class="built_in">strstr</span>(buf, <span class="string">&quot;Connection:&quot;</span>)) != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            Connection = <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>( (findp = <span class="built_in">strstr</span>(buf, <span class="string">&quot;Host:&quot;</span>)) != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            HostInfo = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        n = <span class="built_in">Rio_readlineb</span>(rio, buf, MAXLINE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(n == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(HostInfo == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(buf, <span class="string">&quot;Host: %s\r\n&quot;</span>, Host);</span><br><span class="line">        <span class="built_in">strcat</span>(clientRequest, buf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** append User-Agent */</span></span><br><span class="line">    <span class="keyword">if</span>(UserAgent == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">strcat</span>(clientRequest, user_agent_hdr);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** append Connection */</span></span><br><span class="line">    <span class="keyword">if</span>(Connection == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(buf, <span class="string">&quot;Connection: close\r\n&quot;</span>);</span><br><span class="line">        <span class="built_in">strcat</span>(clientRequest, buf);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** append Proxy-Connection */</span></span><br><span class="line">    <span class="keyword">if</span>(ProxyConnection == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(buf, <span class="string">&quot;Proxy-Connection: close\r\n&quot;</span>);</span><br><span class="line">        <span class="built_in">strcat</span>(clientRequest, buf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* add terminator for request */</span></span><br><span class="line">    <span class="built_in">strcat</span>(clientRequest, <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">replaceHTTPVersion</span><span class="params">(<span class="type">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="type">char</span> *pos =<span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span>((pos=<span class="built_in">strstr</span>(buf,<span class="string">&quot;HTTP/1.1&quot;</span>))!=<span class="literal">NULL</span>)&#123;</span><br><span class="line">        buf[pos-buf+<span class="built_in">strlen</span>(<span class="string">&quot;HTTP/1.1&quot;</span>)<span class="number">-1</span>]=<span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">parseLine</span><span class="params">(<span class="type">char</span>* buf, <span class="type">char</span>* host, <span class="type">char</span>* port, <span class="type">char</span>* method, <span class="type">char</span>* uri, <span class="type">char</span>* version, <span class="type">char</span>* filename)</span></span>&#123;</span><br><span class="line">    <span class="built_in">sscanf</span>(buf, <span class="string">&quot;%s %s %s&quot;</span>,method,uri,version);</span><br><span class="line">    <span class="comment">//method = &quot;GET&quot;, uri = &quot;http://localhost:15213/home.html&quot;, version = &quot;HTTP1.0&quot;</span></span><br><span class="line">    <span class="type">char</span>* hostp = <span class="built_in">strstr</span>(uri, WEB_PREFIX) + <span class="built_in">strlen</span>(WEB_PREFIX);</span><br><span class="line">    <span class="type">char</span>* slash = <span class="built_in">strstr</span>(hostp, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="type">char</span>* colon = <span class="built_in">strstr</span>(hostp, <span class="string">&quot;:&quot;</span>);</span><br><span class="line">    <span class="comment">//get host name</span></span><br><span class="line">    <span class="built_in">strncpy</span>(host, hostp, slash - hostp);  </span><br><span class="line">    <span class="comment">//get port number</span></span><br><span class="line">    <span class="built_in">strncpy</span>(port, colon + <span class="number">1</span>, slash - colon - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//get file name</span></span><br><span class="line">    <span class="built_in">strcpy</span>(filename, slash);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    host : localhost:15214</span></span><br><span class="line"><span class="comment">    filename: /home.html</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// html headers and response body</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">clienterror</span><span class="params">(<span class="type">int</span> fd,<span class="type">char</span> *cause,<span class="type">char</span> *errnum, <span class="type">char</span> *shortmsg, <span class="type">char</span> *longmsg)</span></span>&#123;</span><br><span class="line">    <span class="type">char</span> buf[MAXLINE];</span><br><span class="line">    <span class="comment">/* Print the HTTP response headers */</span></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;HTTP/1.0 %s %s\r\n&quot;</span>, errnum, shortmsg);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;Content-type: text/html\r\n\r\n&quot;</span>);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Print the HTTP response body */</span></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;&lt;html&gt;&lt;title&gt;Tiny Error&lt;/title&gt;&quot;</span>);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;&lt;body bgcolor=&quot;</span><span class="string">&quot;ffffff&quot;</span><span class="string">&quot;&gt;\r\n&quot;</span>);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;%s: %s\r\n&quot;</span>, errnum, shortmsg);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;&lt;p&gt;%s: %s\r\n&quot;</span>, longmsg, cause);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;&lt;hr&gt;&lt;em&gt;The Tiny Web server&lt;/em&gt;\r\n&quot;</span>);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="PART-II"><a href="#PART-II" class="headerlink" title="PART II"></a>PART II</h3><h4 id="测试大坑："><a href="#测试大坑：" class="headerlink" title="测试大坑："></a>测试大坑：</h4><p>Driver.sh的301行左右，要修正</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202408180454911.png" alt="image-20240818044744099"></p>
<p>要有python程序执行nop-sever.py的脚本，需要使用<code>python --version</code>命令看自己的python是什么版本</p>
<h4 id="代码大纲"><a href="#代码大纲" class="headerlink" title="代码大纲"></a>代码大纲</h4><p>**主函数 (<code>main</code>)**：</p>
<ul>
<li>初始化读写锁 (<code>rwlock_init</code>)，用于控制对共享资源的访问。</li>
<li>监听指定端口的连接请求。</li>
<li>接受客户端连接，并为每个连接创建一个新的线程进行处理 (<code>thread</code> 函数)。</li>
</ul>
<p>**读写锁 (<code>rwlock_init</code>)**：</p>
<ul>
<li>初始化了读锁和写锁，用于同步读写操作。</li>
</ul>
<p>**线程处理函数 (<code>thread</code>)**：</p>
<ul>
<li>分离当前线程，并调用 <code>handlerequest</code> 处理客户端请求。</li>
</ul>
<p>**请求处理函数 (<code>handlerequest</code>)**：</p>
<ul>
<li>读取客户端请求，解析请求行和头部信息。</li>
<li>调用 <code>MakeClientRequest</code> 构建发送到目标服务器的请求。</li>
<li>将目标服务器的响应返回给客户端。</li>
</ul>
<p>**请求构建函数 (<code>MakeClientRequest</code>)**：</p>
<ul>
<li>读取客户端请求头，处理必要的字段（如 User-Agent、Connection、Proxy-Connection 和 Host）。</li>
<li>形成完整的请求并准备发送到目标服务器。</li>
</ul>
<p>**替换 HTTP 版本函数 (<code>replaceHTTPVersion</code>)**：</p>
<ul>
<li>将 HTTP&#x2F;1.1 替换为 HTTP&#x2F;1.0，以兼容目标服务器。</li>
</ul>
<p>**解析请求行函数 (<code>parseLine</code>)**：</p>
<ul>
<li>解析请求行，提取主机、端口、URI 和文件名等信息。</li>
</ul>
<p>**错误处理函数 (<code>Clienterror</code>)**：</p>
<ul>
<li>构建并发送一个标准的 HTTP 错误响应给客户端。</li>
</ul>
<h4 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码:"></a>完整代码:</h4><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;csapp.h&quot;</span></span></span><br><span class="line"><span class="comment">/* Recommended max cache and object sizes */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_CACHE_SIZE 1049000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MAX_OBJECT_SIZE 102400</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WEB_PREFIX <span class="string">&quot;http://&quot;</span></span></span><br><span class="line"><span class="comment">/* You won&#x27;t lose style points for including this long line in your code */</span></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span> *user_agent_hdr = <span class="string">&quot;User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:10.0.3) Gecko/20120305 Firefox/10.0.3\r\n&quot;</span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">handlerequest</span><span class="params">(<span class="type">int</span>)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Clienterror</span><span class="params">(<span class="type">int</span> , <span class="type">char</span>* , <span class="type">char</span>* , <span class="type">char</span>* , <span class="type">char</span>* )</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">MakeClientRequest</span><span class="params">(<span class="type">rio_t</span>* , <span class="type">char</span>* , <span class="type">char</span>*, <span class="type">char</span>* , <span class="type">char</span>* , <span class="type">char</span>* , <span class="type">char</span>*, <span class="type">char</span>*)</span></span>;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">checkGetMethod</span><span class="params">(<span class="type">char</span>* , <span class="type">char</span>* , <span class="type">char</span>* )</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">replaceHTTPVersion</span><span class="params">(<span class="type">char</span>* )</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">parseLine</span><span class="params">(<span class="type">char</span>* , <span class="type">char</span>*, <span class="type">char</span>* , <span class="type">char</span>* , <span class="type">char</span>* , <span class="type">char</span>*, <span class="type">char</span>*)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">thread</span><span class="params">(<span class="type">void</span> *v)</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rwlock_init</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">rwlock_t</span>&#123;</span><br><span class="line">    <span class="type">sem_t</span> lock;</span><br><span class="line">    <span class="type">sem_t</span> writelock;</span><br><span class="line">    <span class="type">int</span> readers;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">int</span> nowpointer;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Cache</span> cache[MAXLINE];</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">rwlock_t</span> *rw;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc,<span class="type">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    rw= <span class="built_in">Malloc</span>(<span class="built_in">sizeof</span>(<span class="keyword">struct</span> <span class="type">rwlock_t</span>));</span><br><span class="line">    <span class="type">pthread_t</span> tid;</span><br><span class="line">    <span class="type">int</span> listenfd,connfd;</span><br><span class="line">    <span class="built_in">rwlock_init</span>();</span><br><span class="line">    <span class="type">char</span> hostname[MAXLINE],port[MAXLINE];</span><br><span class="line">    <span class="type">socklen_t</span> clientlen;</span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_storage</span> clientaddr;</span><br><span class="line">    <span class="comment">//判断是否是两个命令</span></span><br><span class="line">    <span class="keyword">if</span>(argc!=<span class="number">2</span>)&#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr,<span class="string">&quot;usage: Fuck ,can you input only two string ?\nsuch as%s &lt;port&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">       <span class="comment">// printf(&quot;Fuck ,input right message \n&quot;);</span></span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    listenfd =<span class="built_in">Open_listenfd</span>(argv[<span class="number">1</span>]);   <span class="comment">//listen a port</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        clientlen =<span class="built_in">sizeof</span> (clientaddr);</span><br><span class="line">        connfd = <span class="built_in">Accept</span>(listenfd ,(SA *)&amp;clientaddr, &amp;clientlen);</span><br><span class="line">        <span class="built_in">Getnameinfo</span>((SA *)&amp;clientaddr ,clientlen,hostname ,MAXLINE,port,MAXLINE,<span class="number">0</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Accepted connection from (%s , %s)\n&quot;</span>, hostname ,port);<span class="comment">// accept了</span></span><br><span class="line">        <span class="comment">//Connection Succeed</span></span><br><span class="line">       <span class="built_in">Pthread_create</span>(&amp;tid,<span class="literal">NULL</span>,(<span class="type">void</span>*) thread,(<span class="type">void</span>*)&amp;connfd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">rwlock_init</span><span class="params">()</span></span>&#123;</span><br><span class="line">    rw-&gt;readers=<span class="number">0</span>;</span><br><span class="line">    <span class="built_in">sem_init</span>(&amp;rw-&gt;lock,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    sem_init 是一个用于初始化信号量的函数。这里初始化了 rw-&gt;lock 信号量。</span></span><br><span class="line"><span class="comment">    0 表示信号量用于线程间同步（而非进程间同步）。</span></span><br><span class="line"><span class="comment">    1 表示信号量的初始值为 1，即该信号量是一个二值信号量，用于互斥访问。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="built_in">sem_init</span>(&amp;rw-&gt;writelock,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> *<span class="title">thread</span><span class="params">(<span class="type">void</span> *v)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> fd=*(<span class="type">int</span>*)v;</span><br><span class="line">    <span class="built_in">Pthread_detach</span>(<span class="built_in">pthread_self</span>());</span><br><span class="line">    <span class="built_in">handlerequest</span>(fd);</span><br><span class="line">   <span class="comment">// Free(v);</span></span><br><span class="line">    <span class="built_in">Close</span>(fd);</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">handlerequest</span><span class="params">(<span class="type">int</span> fd)</span></span>&#123;</span><br><span class="line">    <span class="type">char</span> buf[MAXLINE],method[MAXLINE],uri[MAXLINE],version[MAXLINE];<span class="comment">// buf </span></span><br><span class="line">    <span class="type">char</span> filename[MAXLINE];</span><br><span class="line">    <span class="comment">//request header</span></span><br><span class="line">    <span class="type">char</span> host[MAXLINE],port[MAXLINE];</span><br><span class="line">    <span class="type">char</span> clientRequest[MAXLINE];</span><br><span class="line">    <span class="comment">// IO for proxy--client ,proxy--server</span></span><br><span class="line">    <span class="type">rio_t</span> rio,riotiny;</span><br><span class="line">    <span class="comment">// Read request line and headers</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// step1: read request from client</span></span><br><span class="line">    <span class="built_in">Rio_readinitb</span>(&amp;rio,fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!<span class="built_in">Rio_readlineb</span>(&amp;rio ,buf, MAXLINE))<span class="comment">//把输入的命令给到buf缓冲区</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;empty request \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ;<span class="comment">// empty-&gt; close</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// # HTTP/1.1 --&gt; HTTp/1.0</span></span><br><span class="line">    <span class="built_in">replaceHTTPVersion</span>(buf);</span><br><span class="line">   <span class="built_in">parseLine</span>(buf,host,port,method,uri,version,filename);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">strcasecmp</span>(method, <span class="string">&quot;GET&quot;</span>))&#123;</span><br><span class="line">        <span class="built_in">Clienterror</span>(fd, method, <span class="string">&quot;501&quot;</span>, <span class="string">&quot;Not Implemented&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Tiny does not implement this method&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// parse uri from GET request </span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> rv=<span class="built_in">MakeClientRequest</span>(&amp;rio, clientRequest,host,port,method,uri,version,filename);</span><br><span class="line">    <span class="keyword">if</span>(rv==<span class="number">0</span>)<span class="keyword">return</span> ;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;========= we have formatted the reqeust into ---------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span>,clientRequest);</span><br><span class="line">    <span class="type">char</span> hostName[<span class="number">100</span>];</span><br><span class="line">    <span class="type">char</span>* colon = <span class="built_in">strstr</span>(host, <span class="string">&quot;:&quot;</span>);</span><br><span class="line">    <span class="built_in">strncpy</span>(hostName, host, colon - host);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;host is %s\n&quot;</span>, hostName);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;port is %s\n&quot;</span>, port);</span><br><span class="line">    <span class="comment">//模拟一个clientfd</span></span><br><span class="line">    <span class="type">int</span> clientfd = <span class="built_in">Open_clientfd</span>(hostName, port);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Rio_readinitb</span>(&amp;riotiny, clientfd);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(riotiny.rio_fd, clientRequest, <span class="built_in">strlen</span>(clientRequest));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** step4: read the response from tiny and send it to the client */</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---prepare to get the response---- \n&quot;</span>);</span><br><span class="line">    <span class="type">char</span> tinyResponse[MAXLINE];</span><br><span class="line">    <span class="type">int</span> n; </span><br><span class="line">    <span class="keyword">while</span>( (n = <span class="built_in">Rio_readlineb</span>(&amp;riotiny, tinyResponse, MAXLINE)) != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">Rio_writen</span>(fd, tinyResponse, n);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(clientfd);</span><br><span class="line">    <span class="keyword">return</span> ;  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">MakeClientRequest</span><span class="params">(<span class="type">rio_t</span>* rio, <span class="type">char</span>* clientRequest, <span class="type">char</span>* Host, <span class="type">char</span>* port,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">char</span>* method, <span class="type">char</span>* uri, <span class="type">char</span>* version, <span class="type">char</span>* fileName)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> UserAgent = <span class="number">0</span>, Connection = <span class="number">0</span>, ProxyConnection = <span class="number">0</span>, HostInfo = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> buf[MAXLINE / <span class="number">2</span>];</span><br><span class="line">    <span class="type">int</span> n;</span><br><span class="line">    <span class="comment">/* 1. add GET HOSTNAME HTTP/1.0 to header &amp;&amp; Host Info */</span></span><br><span class="line">    <span class="built_in">sprintf</span>(clientRequest, <span class="string">&quot;GET %s HTTP/1.0\r\n&quot;</span>, fileName);</span><br><span class="line"></span><br><span class="line">    n = <span class="built_in">Rio_readlineb</span>(rio, buf, MAXLINE);<span class="comment">// n是读取的字节数</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;receive buf %s\n&quot;</span>, buf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;n == %d\n&quot;</span>, n);</span><br><span class="line">    <span class="type">char</span>* findp;</span><br><span class="line">    <span class="keyword">while</span>(<span class="built_in">strcmp</span>(<span class="string">&quot;\r\n&quot;</span>, buf) != <span class="number">0</span> &amp;&amp; n != <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">strcat</span>(clientRequest, buf);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;receive buf %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( (findp = <span class="built_in">strstr</span>(buf, <span class="string">&quot;User-Agent:&quot;</span>)) != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            UserAgent = <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>( (findp = <span class="built_in">strstr</span>(buf, <span class="string">&quot;Proxy-Connection:&quot;</span>)) != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            ProxyConnection = <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>( (findp = <span class="built_in">strstr</span>(buf, <span class="string">&quot;Connection:&quot;</span>)) != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            Connection = <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>( (findp = <span class="built_in">strstr</span>(buf, <span class="string">&quot;Host:&quot;</span>)) != <span class="literal">NULL</span>)&#123;</span><br><span class="line">            HostInfo = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        n = <span class="built_in">Rio_readlineb</span>(rio, buf, MAXLINE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(n == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(HostInfo == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(buf, <span class="string">&quot;Host: %s\r\n&quot;</span>, Host);</span><br><span class="line">        <span class="built_in">strcat</span>(clientRequest, buf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/** append User-Agent */</span></span><br><span class="line">    <span class="keyword">if</span>(UserAgent == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">strcat</span>(clientRequest, user_agent_hdr);</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="comment">/** append Connection */</span></span><br><span class="line">    <span class="keyword">if</span>(Connection == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(buf, <span class="string">&quot;Connection: close\r\n&quot;</span>);</span><br><span class="line">        <span class="built_in">strcat</span>(clientRequest, buf);</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="comment">/** append Proxy-Connection */</span></span><br><span class="line">    <span class="keyword">if</span>(ProxyConnection == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">sprintf</span>(buf, <span class="string">&quot;Proxy-Connection: close\r\n&quot;</span>);</span><br><span class="line">        <span class="built_in">strcat</span>(clientRequest, buf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* add terminator for request */</span></span><br><span class="line">    <span class="built_in">strcat</span>(clientRequest, <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">replaceHTTPVersion</span><span class="params">(<span class="type">char</span> *buf)</span></span>&#123;</span><br><span class="line">    <span class="type">char</span> *pos =<span class="literal">NULL</span>;</span><br><span class="line">    <span class="keyword">if</span>((pos=<span class="built_in">strstr</span>(buf,<span class="string">&quot;HTTP/1.1&quot;</span>))!=<span class="literal">NULL</span>)&#123;</span><br><span class="line">        buf[pos-buf+<span class="built_in">strlen</span>(<span class="string">&quot;HTTP/1.1&quot;</span>)<span class="number">-1</span>]=<span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">parseLine</span><span class="params">(<span class="type">char</span>* buf, <span class="type">char</span>* host, <span class="type">char</span>* port, <span class="type">char</span>* method, <span class="type">char</span>* uri, <span class="type">char</span>* version, <span class="type">char</span>* filename)</span></span>&#123;</span><br><span class="line">    <span class="built_in">sscanf</span>(buf, <span class="string">&quot;%s %s %s&quot;</span>,method,uri,version);</span><br><span class="line">    <span class="comment">//method = &quot;GET&quot;, uri = &quot;http://localhost:15213/home.html&quot;, version = &quot;HTTP1.0&quot;</span></span><br><span class="line">    <span class="type">char</span>* hostp = <span class="built_in">strstr</span>(uri, WEB_PREFIX) + <span class="built_in">strlen</span>(WEB_PREFIX);</span><br><span class="line">    <span class="type">char</span>* slash = <span class="built_in">strstr</span>(hostp, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="type">char</span>* colon = <span class="built_in">strstr</span>(hostp, <span class="string">&quot;:&quot;</span>);</span><br><span class="line">    <span class="comment">//get host name</span></span><br><span class="line">    <span class="built_in">strncpy</span>(host, hostp, slash - hostp);  </span><br><span class="line">    <span class="comment">//get port number</span></span><br><span class="line">    <span class="built_in">strncpy</span>(port, colon + <span class="number">1</span>, slash - colon - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//get file name</span></span><br><span class="line">    <span class="built_in">strcpy</span>(filename, slash);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    host : localhost:15214</span></span><br><span class="line"><span class="comment">    filename: /home.html</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// html headers and response body</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Clienterror</span><span class="params">(<span class="type">int</span> fd,<span class="type">char</span> *cause,<span class="type">char</span> *errnum, <span class="type">char</span> *shortmsg, <span class="type">char</span> *longmsg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">char</span> buf[MAXLINE];</span><br><span class="line">    <span class="comment">/* Print the HTTP response headers */</span></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;HTTP/1.0 %s %s\r\n&quot;</span>, errnum, shortmsg);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;Content-type: text/html\r\n\r\n&quot;</span>);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Print the HTTP response body */</span></span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;&lt;html&gt;&lt;title&gt;Tiny Error&lt;/title&gt;&quot;</span>);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;&lt;body bgcolor=&quot;</span><span class="string">&quot;ffffff&quot;</span><span class="string">&quot;&gt;\r\n&quot;</span>);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;%s: %s\r\n&quot;</span>, errnum, shortmsg);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;&lt;p&gt;%s: %s\r\n&quot;</span>, longmsg, cause);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">    <span class="built_in">sprintf</span>(buf, <span class="string">&quot;&lt;hr&gt;&lt;em&gt;The Tiny Web server&lt;/em&gt;\r\n&quot;</span>);</span><br><span class="line">    <span class="built_in">Rio_writen</span>(fd, buf, <span class="built_in">strlen</span>(buf));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Part-III"><a href="#Part-III" class="headerlink" title="Part III"></a>Part III</h3><p>添加了一些cache即可</p>
<h4 id="代码重点："><a href="#代码重点：" class="headerlink" title="代码重点："></a>代码重点：</h4><p>读写cache其实就是给cache建立了一个数组，但是多线程读取写入的时候每次要记得上锁解锁。</p>
<h5 id="cache结构体"><a href="#cache结构体" class="headerlink" title="cache结构体"></a>cache结构体</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Cache</span>&#123;</span><br><span class="line">    <span class="type">int</span> used;</span><br><span class="line">    <span class="type">char</span> key[MAXLINE];</span><br><span class="line">    <span class="type">char</span> value[MAX_OBJECT_SIZE];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h5 id="write-cache"><a href="#write-cache" class="headerlink" title="write_cache"></a>write_cache</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">writecache</span><span class="params">(<span class="type">char</span> * buf,<span class="type">char</span> *key)</span></span>&#123;</span><br><span class="line">    <span class="built_in">sem_wait</span>(&amp;rw-&gt;writelock);</span><br><span class="line">    <span class="type">int</span> index;</span><br><span class="line">    <span class="keyword">while</span>(cache[nowpointer].used!=<span class="number">0</span>)&#123;</span><br><span class="line">        cache[nowpointer].used=<span class="number">0</span>;</span><br><span class="line">        nowpointer=(nowpointer+<span class="number">1</span>)%MAX_CACHE;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    index =nowpointer;</span><br><span class="line">    cache[index].used=<span class="number">1</span>;</span><br><span class="line">    <span class="built_in">strcpy</span>(cache[index].key,key);</span><br><span class="line">    <span class="built_in">strcpy</span>(cache[index].value,buf);</span><br><span class="line">    <span class="built_in">sem_post</span>(&amp;rw-&gt;writelock);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="read-cache"><a href="#read-cache" class="headerlink" title="read_cache"></a>read_cache</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">readcache</span><span class="params">(<span class="type">int</span> fd,<span class="type">char</span> *uri)</span></span>&#123;</span><br><span class="line">    <span class="built_in">sem_wait</span>(&amp;rw-&gt;lock);</span><br><span class="line">    <span class="keyword">if</span>(rw-&gt;readers==<span class="number">0</span>)<span class="built_in">sem_wait</span>(&amp;rw-&gt;writelock);</span><br><span class="line">    rw-&gt;readers++;</span><br><span class="line">    <span class="built_in">sem_post</span>(&amp;rw-&gt;lock);</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="type">int</span> flag=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;MAX_CACHE;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strcmp</span>(uri,cache[i].key)==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">Rio_writen</span>(fd,cache[i].value,<span class="built_in">strlen</span>(cache[i].value));</span><br><span class="line">        <span class="comment">//    printf(&quot;proxy send %d bytes to client\n&quot;, strlen(cache[i].value));</span></span><br><span class="line">            cache[i].used=<span class="number">1</span>;</span><br><span class="line">            flag=<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">sem_wait</span>(&amp;rw-&gt;lock);</span><br><span class="line">    rw-&gt;readers--;</span><br><span class="line">    <span class="keyword">if</span>(rw-&gt;readers==<span class="number">0</span>)</span><br><span class="line">    <span class="built_in">sem_post</span>(&amp;rw-&gt;writelock);</span><br><span class="line">    <span class="built_in">sem_post</span>(&amp;rw-&gt;lock);</span><br><span class="line">    <span class="keyword">return</span> flag;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="完整代码-1"><a href="#完整代码-1" class="headerlink" title="完整代码"></a>完整代码</h4><figure class="highlight d"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br></pre></td><td class="code"><pre><span class="line">#include <span class="string">&quot;csapp.h&quot;</span></span><br><span class="line">#define MAX_CACHE <span class="number">10</span></span><br><span class="line"><span class="comment">/* Recommended max cache and object sizes */</span></span><br><span class="line">#define MAX_CACHE_SIZE <span class="number">1049000</span></span><br><span class="line">#define MAX_OBJECT_SIZE <span class="number">102400</span></span><br><span class="line">#define WEB_PREFIX <span class="string">&quot;http://&quot;</span></span><br><span class="line"><span class="comment">/* You won&#x27;t lose style points for including this long line in your code */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="built_in">char</span> *user_agent_hdr = <span class="string">&quot;User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:10.0.3) Gecko/20120305 Firefox/10.0.3\r\n&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> handlerequest(<span class="keyword">int</span>);</span><br><span class="line"><span class="keyword">void</span> Clienterror(<span class="keyword">int</span> , <span class="built_in">char</span>* , <span class="built_in">char</span>* , <span class="built_in">char</span>* , <span class="built_in">char</span>* );</span><br><span class="line"><span class="keyword">int</span> MakeClientRequest(rio_t* , <span class="built_in">char</span>* , <span class="built_in">char</span>*, <span class="built_in">char</span>* , <span class="built_in">char</span>* , <span class="built_in">char</span>* , <span class="built_in">char</span>*, <span class="built_in">char</span>*);</span><br><span class="line"><span class="keyword">int</span> checkGetMethod(<span class="built_in">char</span>* , <span class="built_in">char</span>* , <span class="built_in">char</span>* );</span><br><span class="line"><span class="keyword">void</span> replaceHTTPVersion(<span class="built_in">char</span>* );</span><br><span class="line"><span class="keyword">void</span> parseLine(<span class="built_in">char</span>* , <span class="built_in">char</span>*, <span class="built_in">char</span>* , <span class="built_in">char</span>* , <span class="built_in">char</span>* , <span class="built_in">char</span>*, <span class="built_in">char</span>*);</span><br><span class="line"><span class="keyword">void</span> *thread(<span class="keyword">void</span> *v);</span><br><span class="line"><span class="keyword">void</span> rwlock_init();</span><br><span class="line"><span class="keyword">int</span> readcache(<span class="keyword">int</span> fd,<span class="built_in">char</span> *key);</span><br><span class="line"><span class="keyword">void</span> writecache(<span class="built_in">char</span> *buf,<span class="built_in">char</span> *key);</span><br><span class="line"><span class="keyword">struct</span> rwlock_t&#123;</span><br><span class="line">    sem_t lock;</span><br><span class="line">    sem_t writelock;</span><br><span class="line">    <span class="keyword">int</span> readers;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> Cache&#123;</span><br><span class="line">    <span class="keyword">int</span> used;</span><br><span class="line">    <span class="built_in">char</span> key[MAXLINE];</span><br><span class="line">    <span class="built_in">char</span> value[MAX_OBJECT_SIZE];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> nowpointer;</span><br><span class="line"><span class="keyword">struct</span> Cache cache[MAXLINE];</span><br><span class="line"><span class="keyword">struct</span> rwlock_t *rw;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> main(<span class="keyword">int</span> argc,<span class="built_in">char</span> **argv)</span><br><span class="line">&#123;</span><br><span class="line">    rw= Malloc(sizeof(<span class="keyword">struct</span> rwlock_t));</span><br><span class="line">    pthread_t tid;</span><br><span class="line">    <span class="keyword">int</span> listenfd,connfd;</span><br><span class="line">    rwlock_init();</span><br><span class="line">    <span class="built_in">char</span> hostname[MAXLINE],port[MAXLINE];</span><br><span class="line">    socklen_t clientlen;</span><br><span class="line">    <span class="keyword">struct</span> sockaddr_storage clientaddr;</span><br><span class="line">    <span class="comment">//判断是否是两个命令</span></span><br><span class="line">    <span class="keyword">if</span>(argc!=<span class="number">2</span>)&#123;</span><br><span class="line">        fprintf(stderr,<span class="string">&quot;usage: Fuck ,can you input only two string ?\nsuch as%s &lt;port&gt;\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">       <span class="comment">// printf(&quot;Fuck ,input right message \n&quot;);</span></span><br><span class="line">        exit(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    listenfd =Open_listenfd(argv[<span class="number">1</span>]);   <span class="comment">//listen a port</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        clientlen =sizeof (clientaddr);</span><br><span class="line">        connfd = Accept(listenfd ,(SA *)&amp;clientaddr, &amp;clientlen);</span><br><span class="line">        Getnameinfo((SA *)&amp;clientaddr ,clientlen,hostname ,MAXLINE,port,MAXLINE,<span class="number">0</span>);</span><br><span class="line">        printf(<span class="string">&quot;Accepted connection from (%s , %s)\n&quot;</span>, hostname ,port);<span class="comment">// accept了</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//Connection Succeed</span></span><br><span class="line">       Pthread_create(&amp;tid,NULL,(<span class="keyword">void</span>*) thread,(<span class="keyword">void</span>*)&amp;connfd);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> rwlock_init()&#123;</span><br><span class="line">    rw-&gt;readers=<span class="number">0</span>;</span><br><span class="line">    sem_init(&amp;rw-&gt;lock,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    sem_init 是一个用于初始化信号量的函数。这里初始化了 rw-&gt;lock 信号量。</span></span><br><span class="line"><span class="comment">    0 表示信号量用于线程间同步（而非进程间同步）。</span></span><br><span class="line"><span class="comment">    1 表示信号量的初始值为 1，即该信号量是一个二值信号量，用于互斥访问。</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    sem_init(&amp;rw-&gt;writelock,<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> *thread(<span class="keyword">void</span> *v)&#123;</span><br><span class="line">    <span class="keyword">int</span> fd=*(<span class="keyword">int</span>*)v;</span><br><span class="line">    Pthread_detach(pthread_self());</span><br><span class="line">    handlerequest(fd);</span><br><span class="line">   <span class="comment">// Free(v);</span></span><br><span class="line">    Close(fd);</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> handlerequest(<span class="keyword">int</span> fd)&#123;</span><br><span class="line">    <span class="built_in">char</span> buf[MAXLINE],method[MAXLINE],uri[MAXLINE],<span class="keyword">version</span>[MAXLINE];<span class="comment">// buf </span></span><br><span class="line">    <span class="built_in">char</span> filename[MAXLINE];</span><br><span class="line">    <span class="comment">//request header</span></span><br><span class="line">    <span class="built_in">char</span> host[MAXLINE],port[MAXLINE];</span><br><span class="line">    <span class="built_in">char</span> clientRequest[MAXLINE];</span><br><span class="line">    <span class="comment">// IO for proxy--client ,proxy--server</span></span><br><span class="line">    rio_t rio,riotiny;</span><br><span class="line">    <span class="comment">// Read request line and headers</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// step1: read request from client</span></span><br><span class="line">    Rio_readinitb(&amp;rio,fd);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(!Rio_readlineb(&amp;rio ,buf, MAXLINE))<span class="comment">//把输入的命令给到buf缓冲区</span></span><br><span class="line">    &#123;</span><br><span class="line">        printf(<span class="string">&quot;empty request \n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ;<span class="comment">// empty-&gt; close</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// # HTTP/1.1 --&gt; HTTp/1.0</span></span><br><span class="line">    replaceHTTPVersion(buf);</span><br><span class="line">   parseLine(buf,host,port,method,uri,<span class="keyword">version</span>,filename);</span><br><span class="line">    <span class="keyword">if</span>(strcasecmp(method, <span class="string">&quot;GET&quot;</span>))&#123;</span><br><span class="line">        Clienterror(fd, method, <span class="string">&quot;501&quot;</span>, <span class="string">&quot;Not Implemented&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;Tiny does not implement this method&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// parse uri from GET request </span></span><br><span class="line">    <span class="keyword">if</span> (readcache(fd,uri)!=<span class="number">0</span>)<span class="keyword">return</span> ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> rv=MakeClientRequest(&amp;rio, clientRequest,host,port,method,uri,<span class="keyword">version</span>,filename);</span><br><span class="line">    <span class="keyword">if</span>(rv==<span class="number">0</span>)<span class="keyword">return</span> ;</span><br><span class="line"></span><br><span class="line">    printf(<span class="string">&quot;========= we have formatted the reqeust into ---------\n&quot;</span>);</span><br><span class="line">    printf(<span class="string">&quot;%s&quot;</span>,clientRequest);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">char</span> hostName[<span class="number">100</span>];</span><br><span class="line">    <span class="built_in">char</span>* colon = strstr(host, <span class="string">&quot;:&quot;</span>);</span><br><span class="line">    strncpy(hostName, host, colon - host);</span><br><span class="line">    printf(<span class="string">&quot;host is %s\n&quot;</span>, hostName);</span><br><span class="line">    printf(<span class="string">&quot;port is %s\n&quot;</span>, port);</span><br><span class="line">    <span class="comment">//模拟一个clientfd</span></span><br><span class="line">    <span class="keyword">int</span> clientfd = Open_clientfd(hostName, port);</span><br><span class="line"></span><br><span class="line">    Rio_readinitb(&amp;riotiny, clientfd);</span><br><span class="line">    Rio_writen(riotiny.rio_fd, clientRequest, strlen(clientRequest));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** step4: read the response from tiny and send it to the client */</span></span><br><span class="line">    <span class="built_in">char</span> cache[MAX_OBJECT_SIZE];</span><br><span class="line">    <span class="keyword">int</span> sum=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    printf(<span class="string">&quot;---prepare to get the response---- \n&quot;</span>);</span><br><span class="line">    <span class="built_in">char</span> tinyResponse[MAXLINE];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">while</span>( (n = Rio_readlineb(&amp;riotiny, tinyResponse, MAXLINE)) != <span class="number">0</span>)&#123;</span><br><span class="line">        Rio_writen(fd, tinyResponse, n);</span><br><span class="line">        sum+=n;</span><br><span class="line">        strcat(cache,tinyResponse);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    printf(<span class="string">&quot;proxy send %d bytes to client\n&quot;</span>,sum);</span><br><span class="line">    <span class="keyword">if</span>(sum&lt;MAX_OBJECT_SIZE)</span><br><span class="line">     writecache(cache,uri);</span><br><span class="line">    close(clientfd);</span><br><span class="line">    <span class="keyword">return</span> ;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> writecache(<span class="built_in">char</span> * buf,<span class="built_in">char</span> *key)&#123;</span><br><span class="line">    sem_wait(&amp;rw-&gt;writelock);</span><br><span class="line">    <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">while</span>(cache[nowpointer].used!=<span class="number">0</span>)&#123;</span><br><span class="line">        cache[nowpointer].used=<span class="number">0</span>;</span><br><span class="line">        nowpointer=(nowpointer+<span class="number">1</span>)%MAX_CACHE;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    index =nowpointer;</span><br><span class="line">    cache[index].used=<span class="number">1</span>;</span><br><span class="line">    strcpy(cache[index].key,key);</span><br><span class="line">    strcpy(cache[index].value,buf);</span><br><span class="line">    sem_post(&amp;rw-&gt;writelock);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> readcache(<span class="keyword">int</span> fd,<span class="built_in">char</span> *uri)&#123;</span><br><span class="line">    sem_wait(&amp;rw-&gt;lock);</span><br><span class="line">    <span class="keyword">if</span>(rw-&gt;readers==<span class="number">0</span>)sem_wait(&amp;rw-&gt;writelock);</span><br><span class="line">    rw-&gt;readers++;</span><br><span class="line">    sem_post(&amp;rw-&gt;lock);</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> flag=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;MAX_CACHE;i++)&#123;</span><br><span class="line">        <span class="keyword">if</span>(strcmp(uri,cache[i].key)==<span class="number">0</span>)&#123;</span><br><span class="line">            Rio_writen(fd,cache[i].value,strlen(cache[i].value));</span><br><span class="line">        <span class="comment">//    printf(&quot;proxy send %d bytes to client\n&quot;, strlen(cache[i].value));</span></span><br><span class="line">            cache[i].used=<span class="number">1</span>;</span><br><span class="line">            flag=<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    sem_wait(&amp;rw-&gt;lock);</span><br><span class="line">    rw-&gt;readers--;</span><br><span class="line">    <span class="keyword">if</span>(rw-&gt;readers==<span class="number">0</span>)</span><br><span class="line">    sem_post(&amp;rw-&gt;writelock);</span><br><span class="line">    sem_post(&amp;rw-&gt;lock);</span><br><span class="line">    <span class="keyword">return</span> flag;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">int</span> MakeClientRequest(rio_t* rio, <span class="built_in">char</span>* clientRequest, <span class="built_in">char</span>* Host, <span class="built_in">char</span>* port,</span><br><span class="line">                        <span class="built_in">char</span>* method, <span class="built_in">char</span>* uri, <span class="built_in">char</span>* <span class="keyword">version</span>, <span class="built_in">char</span>* fileName)&#123;</span><br><span class="line">    <span class="keyword">int</span> UserAgent = <span class="number">0</span>, Connection = <span class="number">0</span>, ProxyConnection = <span class="number">0</span>, HostInfo = <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">char</span> buf[MAXLINE / <span class="number">2</span>];</span><br><span class="line">    <span class="keyword">int</span> n;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* 1. add GET HOSTNAME HTTP/1.0 to header &amp;&amp; Host Info */</span></span><br><span class="line">    sprintf(clientRequest, <span class="string">&quot;GET %s HTTP/1.0\r\n&quot;</span>, fileName);</span><br><span class="line"></span><br><span class="line">    n = Rio_readlineb(rio, buf, MAXLINE);<span class="comment">// n是读取的字节数</span></span><br><span class="line">    printf(<span class="string">&quot;receive buf %s\n&quot;</span>, buf);</span><br><span class="line">    printf(<span class="string">&quot;n == %d\n&quot;</span>, n);</span><br><span class="line">    <span class="built_in">char</span>* findp;</span><br><span class="line">    <span class="keyword">while</span>(strcmp(<span class="string">&quot;\r\n&quot;</span>, buf) != <span class="number">0</span> &amp;&amp; n != <span class="number">0</span>)&#123;</span><br><span class="line">        strcat(clientRequest, buf);</span><br><span class="line">        printf(<span class="string">&quot;receive buf %s\n&quot;</span>, buf);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>( (findp = strstr(buf, <span class="string">&quot;User-Agent:&quot;</span>)) != NULL)&#123;</span><br><span class="line">            UserAgent = <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>( (findp = strstr(buf, <span class="string">&quot;Proxy-Connection:&quot;</span>)) != NULL)&#123;</span><br><span class="line">            ProxyConnection = <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>( (findp = strstr(buf, <span class="string">&quot;Connection:&quot;</span>)) != NULL)&#123;</span><br><span class="line">            Connection = <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span>( (findp = strstr(buf, <span class="string">&quot;Host:&quot;</span>)) != NULL)&#123;</span><br><span class="line">            HostInfo = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        n = Rio_readlineb(rio, buf, MAXLINE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(n == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(HostInfo == <span class="number">0</span>)&#123;</span><br><span class="line">        sprintf(buf, <span class="string">&quot;Host: %s\r\n&quot;</span>, Host);</span><br><span class="line">        strcat(clientRequest, buf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** append User-Agent */</span></span><br><span class="line">    <span class="keyword">if</span>(UserAgent == <span class="number">0</span>)&#123;</span><br><span class="line">        strcat(clientRequest, user_agent_hdr);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** append Connection */</span></span><br><span class="line">    <span class="keyword">if</span>(Connection == <span class="number">0</span>)&#123;</span><br><span class="line">        sprintf(buf, <span class="string">&quot;Connection: close\r\n&quot;</span>);</span><br><span class="line">        strcat(clientRequest, buf);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/** append Proxy-Connection */</span></span><br><span class="line">    <span class="keyword">if</span>(ProxyConnection == <span class="number">0</span>)&#123;</span><br><span class="line">        sprintf(buf, <span class="string">&quot;Proxy-Connection: close\r\n&quot;</span>);</span><br><span class="line">        strcat(clientRequest, buf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* add terminator for request */</span></span><br><span class="line">    strcat(clientRequest, <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> replaceHTTPVersion(<span class="built_in">char</span> *buf)&#123;</span><br><span class="line">    <span class="built_in">char</span> *pos =NULL;</span><br><span class="line">    <span class="keyword">if</span>((pos=strstr(buf,<span class="string">&quot;HTTP/1.1&quot;</span>))!=NULL)&#123;</span><br><span class="line">        buf[pos-buf+strlen(<span class="string">&quot;HTTP/1.1&quot;</span>)-<span class="number">1</span>]=<span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> parseLine(<span class="built_in">char</span>* buf, <span class="built_in">char</span>* host, <span class="built_in">char</span>* port, <span class="built_in">char</span>* method, <span class="built_in">char</span>* uri, <span class="built_in">char</span>* <span class="keyword">version</span>, <span class="built_in">char</span>* filename)&#123;</span><br><span class="line">    sscanf(buf, <span class="string">&quot;%s %s %s&quot;</span>,method,uri,<span class="keyword">version</span>);</span><br><span class="line">    <span class="comment">//method = &quot;GET&quot;, uri = &quot;http://localhost:15213/home.html&quot;, version = &quot;HTTP1.0&quot;</span></span><br><span class="line">    <span class="built_in">char</span>* hostp = strstr(uri, WEB_PREFIX) + strlen(WEB_PREFIX);</span><br><span class="line">    <span class="built_in">char</span>* slash = strstr(hostp, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    <span class="built_in">char</span>* colon = strstr(hostp, <span class="string">&quot;:&quot;</span>);</span><br><span class="line">    <span class="comment">//get host name</span></span><br><span class="line">    strncpy(host, hostp, slash - hostp);  </span><br><span class="line">    <span class="comment">//get port number</span></span><br><span class="line">    strncpy(port, colon + <span class="number">1</span>, slash - colon - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">//get file name</span></span><br><span class="line">    strcpy(filename, slash);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    host : localhost:15214</span></span><br><span class="line"><span class="comment">    filename: /home.html</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// html headers and response body</span></span><br><span class="line"><span class="keyword">void</span> Clienterror(<span class="keyword">int</span> fd,<span class="built_in">char</span> *cause,<span class="built_in">char</span> *errnum, <span class="built_in">char</span> *shortmsg, <span class="built_in">char</span> *longmsg)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">char</span> buf[MAXLINE];</span><br><span class="line">    <span class="comment">/* Print the HTTP response headers */</span></span><br><span class="line">    sprintf(buf, <span class="string">&quot;HTTP/1.0 %s %s\r\n&quot;</span>, errnum, shortmsg);</span><br><span class="line">    Rio_writen(fd, buf, strlen(buf));</span><br><span class="line">    sprintf(buf, <span class="string">&quot;Content-type: text/html\r\n\r\n&quot;</span>);</span><br><span class="line">    Rio_writen(fd, buf, strlen(buf));</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Print the HTTP response body */</span></span><br><span class="line">    sprintf(buf, <span class="string">&quot;&lt;html&gt;&lt;title&gt;Tiny Error&lt;/title&gt;&quot;</span>);</span><br><span class="line">    Rio_writen(fd, buf, strlen(buf));</span><br><span class="line">    sprintf(buf, <span class="string">&quot;&lt;body bgcolor=&quot;</span><span class="string">&quot;ffffff&quot;</span><span class="string">&quot;&gt;\r\n&quot;</span>);</span><br><span class="line">    Rio_writen(fd, buf, strlen(buf));</span><br><span class="line">    sprintf(buf, <span class="string">&quot;%s: %s\r\n&quot;</span>, errnum, shortmsg);</span><br><span class="line">    Rio_writen(fd, buf, strlen(buf));</span><br><span class="line">    sprintf(buf, <span class="string">&quot;&lt;p&gt;%s: %s\r\n&quot;</span>, longmsg, cause);</span><br><span class="line">    Rio_writen(fd, buf, strlen(buf));</span><br><span class="line">    sprintf(buf, <span class="string">&quot;&lt;hr&gt;&lt;em&gt;The Tiny Web server&lt;/em&gt;\r\n&quot;</span>);</span><br><span class="line">    Rio_writen(fd, buf, strlen(buf));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202408180455756.png" alt="image-20240818045547484"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这是一场旷日持久的斗争！</p>
<p>但是我学到了很多！</p>
<p>感谢CMU 15-213 CSAPP!</p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag"># 学习笔记</a>
              <a href="/tags/csapp/" rel="tag"># csapp</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/CSAPP/lab0/2024/02/27/" rel="prev" title="CSAPP自学指北">
      <i class="fa fa-chevron-left"></i> CSAPP自学指北
    </a></div>
      <div class="post-nav-item">
    <a href="/CSAPP/lab5/2024/03/10/" rel="next" title="CSAPP的lab5-cachelab">
      CSAPP的lab5-cachelab <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#ProxyLab"><span class="nav-number">1.</span> <span class="nav-text">ProxyLab</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%BE%E6%9C%AC%E7%9F%A5%E8%AF%86%E7%A0%94%E8%AF%BB"><span class="nav-number">1.1.</span> <span class="nav-text">课本知识研读</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Chapter-10-System-Level-I-O"><span class="nav-number">1.1.1.</span> <span class="nav-text">Chapter 10 System-Level I&#x2F;O</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Chapter-11-Network-Programming"><span class="nav-number">1.1.2.</span> <span class="nav-text">Chapter 11 Network Programming</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Tiny-Sever%E6%B5%8B%E8%AF%95"><span class="nav-number">1.1.2.1.</span> <span class="nav-text">Tiny Sever测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Tiny%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number">1.1.2.2.</span> <span class="nav-text">Tiny源码分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Chapter-12-Concurrent-Programming"><span class="nav-number">1.1.3.</span> <span class="nav-text">Chapter 12 Concurrent Programming</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Lab"><span class="nav-number">1.2.</span> <span class="nav-text">Lab</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E8%B0%83%E8%AF%95"><span class="nav-number">1.2.1.</span> <span class="nav-text">环境调试</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%AE%E6%A0%87%E6%80%BB%E8%A7%88"><span class="nav-number">1.2.2.</span> <span class="nav-text">目标总览</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Part1"><span class="nav-number">1.2.3.</span> <span class="nav-text">Part1</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-main"><span class="nav-number">1.2.3.1.</span> <span class="nav-text">1. main</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-handleRequest"><span class="nav-number">1.2.3.2.</span> <span class="nav-text">2. handleRequest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-MakeClientRequest"><span class="nav-number">1.2.3.3.</span> <span class="nav-text">3. MakeClientRequest</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-replaceHTTPVersion"><span class="nav-number">1.2.3.4.</span> <span class="nav-text">4. replaceHTTPVersion</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-parseLine"><span class="nav-number">1.2.3.5.</span> <span class="nav-text">5. parseLine</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#6-clientError"><span class="nav-number">1.2.3.6.</span> <span class="nav-text">6. clientError</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81%EF%BC%9A"><span class="nav-number">1.2.3.7.</span> <span class="nav-text">完整代码：</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PART-II"><span class="nav-number">1.2.4.</span> <span class="nav-text">PART II</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95%E5%A4%A7%E5%9D%91%EF%BC%9A"><span class="nav-number">1.2.4.1.</span> <span class="nav-text">测试大坑：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E5%A4%A7%E7%BA%B2"><span class="nav-number">1.2.4.2.</span> <span class="nav-text">代码大纲</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81"><span class="nav-number">1.2.4.3.</span> <span class="nav-text">完整代码:</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Part-III"><span class="nav-number">1.2.5.</span> <span class="nav-text">Part III</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E9%87%8D%E7%82%B9%EF%BC%9A"><span class="nav-number">1.2.5.1.</span> <span class="nav-text">代码重点：</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#cache%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">1.2.5.1.1.</span> <span class="nav-text">cache结构体</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#write-cache"><span class="nav-number">1.2.5.1.2.</span> <span class="nav-text">write_cache</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#read-cache"><span class="nav-number">1.2.5.1.3.</span> <span class="nav-text">read_cache</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%8C%E6%95%B4%E4%BB%A3%E7%A0%81-1"><span class="nav-number">1.2.5.2.</span> <span class="nav-text">完整代码</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">2.</span> <span class="nav-text">总结</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="zhz_vite"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">zhz_vite</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">40</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zhzvite" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zhzvite" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2811215248@qq.com" title="E-Mail → mailto:2811215248@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhz_vite</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">405k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">12:16</span>
</div>
<!-- 网站运行时间的设置 -->
<span id="timeDate">载入天数...</span>
<span id="times">载入时分秒...</span>
<script>
    var now = new Date();
    function createtime() {
        var grt= new Date("01/01/2024 00:00:00"); //此处修改你的建站时间或者网站上线时间
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "本站已半死不活地运行 "+dnum+" 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒.";
    }
setInterval("createtime()",250);
</script>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'FjQmI706XTGQP3WHoYu51jaj-gzGzoHsz',
      appKey     : '7f8iu1agX4mrT7NPuBgu9HVw',
      placeholder: "随便说点吧哥们",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
